---
title: "Manuscript figures"
author: "Sven Tobias-HÃ¼nefeldt"
date: "20/01/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
#Load packages 
```{r}
library(ggplot2)
library(ggpubr)
library(vegan)
library(plyr)
library(dplyr)
library(tidyr)
library(forcats)

```
#Make environment and functions 
```{r Set up environment}
#Set seed to make results more reproducible
set.seed(2)
#Set language to english
Sys.setenv(LANG = "en")
#Set up working directory
setwd("/YOUR/PATH/HERE/")
#Define theme for plotting
My_Theme = theme_bw()+
  theme(axis.title.x = element_text(size=18),
       # theme_grey(base_size = 22),
        axis.text.x = element_text(angle=0, colour = "black", vjust=1, hjust = 0.5, size=18), 
        axis.text.y = element_text(colour = "black", size=18),
        axis.title.y = element_text(size=18),
        plot.title = element_text(size = 18, hjust = 0.5),
        legend.title =element_text(size = 18),
        legend.text = element_text(size = 16),
        legend.position="right",
        legend.key.size = unit(1, "cm"),
        strip.text.x = element_text(size=18, face="bold"),
        strip.text.y = element_text(size=18, face="bold"),
        #panel.background = element_blank(),
        panel.border = element_rect(fill = NA, colour = "black"),
        strip.background = element_rect(colour="black"),
       text = element_text(family = "sans"))

Poster_Theme = theme_bw()+
  theme(axis.title.x = element_text(size=28),
       # theme_grey(base_size = 22),
        axis.text.x = element_text(angle=0, colour = "black", vjust=1, hjust = 0.5, size=24), 
        axis.text.y = element_text(colour = "black", size=24),
        axis.title.y = element_text(size=28),
        plot.title = element_text(size = 24, hjust = 0.5),
        legend.title =element_text(size = 28),
        legend.text = element_text(size = 24),
        legend.position="right",
        legend.key.size = unit(1, "cm"),
        strip.text.x = element_text(size=24, face="bold"),
        strip.text.y = element_text(size=24, face="bold"),
        #panel.background = element_blank(),
        panel.border = element_rect(fill = NA, colour = "black"),
        strip.background = element_rect(colour="black"),
       text = element_text(family = "sans"))

#Station specific colours for consistency
Station_colour_list <- c("Station1" =  "black",
                "Station2" = "red",
                #"" = "violet",
                #"" = "violetred4", 
                "Station3" = "navy",
                #"" = "",
                #"" = "thistle3", 
                "Station4" = "forestgreen",
                #"" = "darkred",
                "Station5" = "green",
                #"" = "orange",
                #"" = "turquoise",
                #"" = "cornflowerblue",
                #"" = "beige",
                "Station6" = "magenta")

Date_colour_list <- c("Jul-21" =  "black",
                "May-21" = "red",
                #"" = "violet",
                #"" = "violetred4", 
                #"" = "navy",
                #"" = "",
                #"" = "thistle3", 
                "Feb 22" = "forestgreen",
                #"" = "darkred",
                #"" = "turquoise",
                #"" = "cornflowerblue",
                #"" = "beige",
                "Nov-21" = "magenta",
                "May 22" = "orange",
                "Jun 22" = "green"
                )

#Colourblind friendly pallete
cbbPalette <- c("black",
                "red",
                "navy", 
                "green", 
                "magenta",
                "forestgreen")
#If more options are needed
expanded_cbbPalette <- c("#000000", #Black
                "#E69F00", #Orange
                "#56B4E9", #Blue (light)
                "#009E73", #Sea green
                "#CC79A7", #Magenta (light)
                "#F0E442", #Yellow
                "#0072B2", #Blue
                "#D55E00", #Burnt orange
                "dodgerblue4",
                "rosybrown",
                "floralwhite",
                "lightgoldenrod4",
                "cornsilk3",
                "coral4",
                "gray38",
                "turquoise4",
                "springgreen3",
                "slateblue3",
                "forestgreen",
                "lightgreen") 

#Shapes for ggplot2
Shape_list = c(0, #Hollow square
               15, #Filled square
               1, #Hollow circle
               16, #Filled circle
               2, #Hollow triangle
               17, #Filled triangle
               5, #Hollow diamond
               23) #Filled diamons
                
#Set up position dodge for ggplot2
pd = position_dodge(0.15)

ConditionColourList <- c("AlcianBlue" = "black",
                         "CBBG" = "red")

#Colourblind friendly pallete
FractionColourList <- c("Suspended" = "grey50",
                        "Sinking" = "black")
FractionSecondaryColourList <- c(#"Suspended" = "black",
                                 #"Sinking" = "red",
                                 #"navy",
                                 "Suspended" = "grey", 
                                 "Sinking" = "grey40")


Group_colours = c("Dissolved Organic" = "#000000", #Black
                                           "Dissolved Inorganic" =  "#E69F00", #Orange
                                           "Free-Living Organisms"= "#56B4E9", #Blue (light),
                                           "Suspended PAO" = "#009E73", #Sea green,
                                           "Sinking PAO" = "#CC79A7", #Magenta (light),
                                           "Suspended Organic Particles" = "#F0E442", #Yellow,
                                           "Suspended Inorganic Particles" = "#0072B2", #Blue,
                                           "Sinking Organic Particles" = "#D55E00", #Burnt orange,
                                           "Sinking Inorganic Particles" = "dodgerblue4")

```
```{r Hour:Minute to Hour function}
i="1"
#hours_minutes = Results.df$TimeDiff
hours_minutes_to_hours <- function(hours_minutes) {
  #print(length(hours_minutes))
  
  output =list()
  
  for (i in 1:length(hours_minutes)) {
    if(grepl(pattern =":",  x = hours_minutes[i]) == T) {
    
      splitNumbers = strsplit(hours_minutes[i], split = ":")
      minutes = as.numeric(splitNumbers[[1]][2])/60
      hours = as.numeric(splitNumbers[[1]][1])
    
      tmp_output = as.numeric(hours + minutes)
    
      output = c(output, tmp_output)
    
    }
    else if (grepl(pattern =".",  x = hours_minutes[i]) == T) {
      
      tmp_output = as.numeric(hours_minutes[i])
    
      output = c(output, tmp_output)
    
    }
  else {
    print("Sample did not match format, hours and minutes must be separated by :")
  }  
  }
  
  return(output)
}

```
```{r String cutting function}

substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}

```
#Import dataframes 
```{r Import CHN data}
#Import dataframes
CHN1.raw = readxl::read_excel("YOU/PATH/HERE/Data/Raw_Nov2021_Febr2022_CHNAnalysis.xlsx")
CHN2.raw = readxl::read_excel("YOU/PATH/HERE/Data/Raw_SvenMayJunNov2022.xlsx")
CHN.raw = rbind(CHN1.raw, CHN2.raw)

#Subset to actual data
CHN.mod = subset(CHN.raw, Name!="RunIn" & Name!="sulfanilamid" & Name!="leer" & Name!="Blnk" & Nr.!="110" & Nr.!="111" & Nr.!="124")
#Also removed sample 110 and 111 as was unbelievable, and was most likely due to contamination

CHN.mod$Name = gsub("-", "P", CHN.mod$Name)


# Sample value * 1735/176.7 mm2 (area difference between 47 mm and 15 mm) * Volume of water filtered to L (100 mL)
CHN.mod$N_mgperL = CHN.mod$`N [%]` * 9.818902 *  10
CHN.mod$C_mgperL = CHN.mod$`C [%]` * 9.818902 *  10
CHN.mod$H_mgperL = CHN.mod$`H [%]` * 9.818902 *  10

# 9.818902 = Correction factor from small cutout to 47 mm filter
# 10 = Sample mL to L

CHN.meta = read.csv("YOU/PATH/HERE/Data/POCPTCPIC_Metadata.csv", sep = ",")
colnames(CHN.meta) = c("FilterNumber", "Station", "Date", "Fraction")
CHN.mod$Station = "test"
CHN.mod$Date = "test"
CHN.mod$Fraction = "test"
CHN.mod$Organic = "test"

i=15
x=4



for (i in 1:length(CHN.mod$Name)) {
  
  for (x in 1:length(CHN.meta$FilterNumber)) {
    
  
  
  if (grepl(paste0("start", strsplit(CHN.mod$Name[i], "P")[[1]][1],"end" ), paste0("start", CHN.meta$FilterNumber[x], "end") ) == T) {
  #if (grepl(strsplit(CHN.mod$Name[i], "P")[[1]][1][1], CHN.meta$FilterNumber[x] ) == T) {
    
    print(paste0("CHN.mod is ", strsplit(CHN.mod$Name[i], "P")[[1]][1], " and CHN.meta is ", CHN.meta$FilterNumber[x]))
    
    
    CHN.mod$Station[i] = CHN.meta$Station[x]
    CHN.mod$Date[i] = CHN.meta$Date[x]
    CHN.mod$Fraction[i] = CHN.meta$Fraction[x]
    
    if (grepl(paste0("start", strsplit(CHN.mod$Name[i], "P")[[1]][2],"end" ), paste0("start", 2, "end") ) == T | 
         grepl(paste0("start", strsplit(CHN.mod$Name[i], "P")[[1]][2],"end" ), paste0("start", 4, "end") ) == T ) {
      
      CHN.mod$Organic[i] = "Organic"
      
    } else {
      
      CHN.mod$Organic[i] = "Total"
    }
    
     }
  }
}


CHN.Elbe = subset(CHN.mod, Fraction == "Light" | Fraction == "Heavy")
CHN.Elbe = subset(CHN.Elbe, Date!="November.2021" & Station!="Bunthaus Spitze")

#CHN.Elbe_v0 = CHN.Elbe


```
```{r Import Microscopy data}
Brightfield_sum.df = read.csv("YOU/PATH/HERE/Data/AllBrightfield_Summary.csv", fileEncoding = "UTF-8-BOM")
Brightfield_sum.df = subset(Brightfield_sum.df, !Date=="2021.11")
#Brightfield.df = read.csv("C:/Users/hunefeldt/OneDrive/Desktop/R_analysis/ParticleAnalysis/Data/All_Summary_IndividualParticles_NewAllBrightfieldOutput.csv", fileEncoding = "UTF-8-BOM")


SYBR_sum.df = read.csv("YOU/PATH/HERE/Data/AllSYBR_Summary.csv", header = T, fileEncoding = "UTF-8-BOM")
SYBR_sum.df = subset(SYBR_sum.df, !Date=="11.2021")
#SYBR.df = read.csv("C:/Users/hunefeldt/OneDrive/Desktop/R_analysis/ParticleAnalysis/Data/All_IndividualParticles_SYBR.csv", header = T, fileEncoding = "UTF-8-BOM")
```
##Convert image specific particle numbers to per L values 
```{r}
#Particle count per L = particle count in image * magnification effect (x630) with field of view * convert from 1 mL sample to L
Brightfield_sum.df$Count = Brightfield_sum.df$Count * 10122.6872775 * 1000
SYBR_sum.df$Count = SYBR_sum.df$Count * 10122.6872775 * 1000

```
##Brightfield correction for Alcian Blue (TEP) and CBBG (CSP)
```{r Correct Brightfield for FDR based on colour deconvolution}
#Import false discovery files
FalseDiscovery_sum.df = read.csv("YOU/PATH/HERE/Data/AllFalseDiscovery_Summary.csv", fileEncoding = "UTF-8-BOM")
FalseDiscovery_sum.df = subset(FalseDiscovery_sum.df, !Date=="11.2021")

#Multiply to per Litre values
FalseDiscovery_sum.df$Count = FalseDiscovery_sum.df$Count * 10122.6872775 * 1000

##Multiply area and count for area per Litre values
Brightfield_sum.df$AreaL = Brightfield_sum.df$Count * Brightfield_sum.df$Average_Size
FalseDiscovery_sum.df$Combined = FalseDiscovery_sum.df$Count * FalseDiscovery_sum.df$Average_Size

#Control for NA values
FalseDiscovery_sum.df$Combined[is.na(FalseDiscovery_sum.df$Combined)] <- 0

#Calculate FDR rates dependent on station, fraction, and what we're correcting
CorrectionSpread = FalseDiscovery_sum.df %>%
  group_by(CorrectionFor, Date, Station, Fraction) %>%
  dplyr::summarise(mean_val = mean(Combined), sd = sd(Combined), median = median(Combined))
print(CorrectionSpread)

#Loop for FDR correction
StationID="Station2"
StainID="AlcianBlue"
FractionID="Light"
Date="7.2021"
Brightfield_sum.df$CorrAreaL = 0
i=385
for (i in 1:length(Brightfield_sum.df$Station)) {
  
  StationID=Brightfield_sum.df$Station[i]
  StainID=Brightfield_sum.df$Condition[i]
  FractionID=Brightfield_sum.df$Fraction[i]
  DateID=Brightfield_sum.df$Date[i]
  
  print(paste0(DateID, StationID, StainID, FractionID))
  
  if (grepl(Brightfield_sum.df$Condition[i], "AlcianBlue") == T | grepl(Brightfield_sum.df$Condition[i], "CBBG") == T) {
  
    Control_mean = subset(CorrectionSpread, Date==DateID & Station==StationID & CorrectionFor==StainID & Fraction==FractionID)$mean_val
    
    Brightfield_sum.df$CorrAreaL[i] = Brightfield_sum.df$AreaL[i] - Control_mean
  
    
  } else {
    
    print("Image was not Alcian Blue or CBBG stained so does not need correcting")
    Brightfield_sum.df$CorrAreaL[i] = Brightfield_sum.df$AreaL[i]
    
  }
}

#Make back up and comment out in case of issues
#Brightfield_sum.df_v0 = Brightfield_sum.df
#To restore in case of downstream issues instead of rerunning loop
#Brightfield_sum.df = Brightfield_sum.df_v0

#Remove non-sensical negative values
Brightfield_sum.df$CorrAreaL[Brightfield_sum.df$CorrAreaL < 0 ] = 0
#Brightfield_sum.df$CorrAreaL[is.na(Brightfield_sum.df$CorrAreaL)] <- 0
#range(Brightfield_sum.df$CorrAreaL)


####Make plot pretty####
#Rename stations for pretty plots
Brightfield_sum.df$Station = gsub("Station2$", "Muhlenberger Loch", Brightfield_sum.df$Station)
Brightfield_sum.df$Station = gsub("Station3$", "Twielenfleth", Brightfield_sum.df$Station)
Brightfield_sum.df$Station = gsub("Station4$", "Schwarztonnensand", Brightfield_sum.df$Station)
Brightfield_sum.df$Station = gsub("Station5$", "Brunsbuttel", Brightfield_sum.df$Station)
Brightfield_sum.df$Station = gsub("Station6$", "Meedem Grund", Brightfield_sum.df$Station)
#Brightfield_sum.df$Station = gsub("Station1.5$", "SeemanshÃ¶ft", Brightfield_sum.df$Station)
#Brightfield_sum.df$Station = gsub("Station4.1$", "Kollmar", Brightfield_sum.df$Station)

Brightfield_sum.df$Stromkilometer = Brightfield_sum.df$Station

#Get distance from Hamburg/Elbe distance for spearman tests
Brightfield_sum.df$Stromkilometer = gsub("Muhlenberger Loch", 633, Brightfield_sum.df$Stromkilometer)
Brightfield_sum.df$Stromkilometer = gsub("Twielenfleth", 651, Brightfield_sum.df$Stromkilometer)
Brightfield_sum.df$Stromkilometer = gsub("Schwarztonnensand", 665, Brightfield_sum.df$Stromkilometer)
Brightfield_sum.df$Stromkilometer = gsub("Brunsbuttel", 694, Brightfield_sum.df$Stromkilometer)
Brightfield_sum.df$Stromkilometer = gsub("Meedem Grund", 712, Brightfield_sum.df$Stromkilometer)
#Brightfield_sum.df$Stromkilometer = gsub("SeemanshÃ¶ft", 629, Brightfield_sum.df$Stromkilometer)
#Brightfield_sum.df$Stromkilometer = gsub("Kollmar", 665, Brightfield_sum.df$Stromkilometer)

Brightfield_sum.df$Stromkilometer = as.numeric(as.character(Brightfield_sum.df$Stromkilometer))

Brightfield_sum.df$Station = factor(Brightfield_sum.df$Station,
                             levels = c("Meedem Grund", 
                                        "Brunsbuttel",
                                        #"Kollmar",
                                        "Schwarztonnensand",
                                        "Twielenfleth",
                                        "Muhlenberger Loch"#,
                                        #"SeemanshÃ¶ft"
                                        ))

Brightfield_sum.df$Fraction = gsub("Light", "Suspended", Brightfield_sum.df$Fraction)
Brightfield_sum.df$Fraction = gsub("Heavy", "Sinking", Brightfield_sum.df$Fraction)
Brightfield_sum.df$Fraction = gsub("0point2", "0.2 filtered", Brightfield_sum.df$Fraction)
Brightfield_sum.df$Fraction = factor(Brightfield_sum.df$Fraction,
                             levels = c("Suspended", "Sinking", "0.2 filtered"))

Brightfield_sum.df$Condition = gsub("AlcianBlue", "TEP", Brightfield_sum.df$Condition)
Brightfield_sum.df$Condition = gsub("CBBG", "CSP", Brightfield_sum.df$Condition)
Brightfield_sum.df$Condition = gsub("Particle", "Unstained", Brightfield_sum.df$Condition)
Brightfield_sum.df$Condition = gsub("0point2", "Unstained 0.2Âµm filtered", Brightfield_sum.df$Condition)
Brightfield_sum.df$Condition = factor(Brightfield_sum.df$Condition,
                             levels = c("Unstained", "Unstained 0.2Âµm filtered", "TEP", "CSP"))


Brightfield_sum.df$Date = factor(Brightfield_sum.df$Date,
                             levels = c("2021.07", 
                                        #"11.2021", 
                                        "2022.02", 
                                        "2022.05", 
                                        "2022.06",
                                        "2022.11"))

#Keep for backup
colnames(Brightfield_sum.df)
CSPMeed.df = data.frame("Station" = "Station6",
                        "Condition" = "CBBG",
                        "Fraction" = "Light",
                        "Date" = "2022.02",
                        "ImageNumber" = 0,
                        "Count" = NA,
                        "Total_Area" = NA,
                        "Average_Size" = NA,
                        "Perc_Area" = NA,
                        "Perim" = NA,
                        "AreaL" = NA,
                        "CorrAreaL" = NA,
                        "Stromkilometer" = NA)


Brightfield_sum_V1.df = rbind(Brightfield_sum.df, CSPMeed.df)
```
#Figure 1 - was adapted from Zimmermann-Timm et al., 1998 in Inkscape
#Figure 2 - TEP and CSP particle area per L 

```{r Basic TEP and CSP area per litre plot}

#Summarise plots for easy plotting
Brightfield_sum_V1.df = na.omit(Brightfield_sum_V1.df)
TEPCSP_AreaL.df = Rmisc::summarySE(Brightfield_sum_V1.df, 
                            measurevar="CorrAreaL", 
                            groupvars=c("Date",
                                        "Station", 
                                        "Condition",
                                        "Fraction"),
                            na.rm = T)

#Remove irrelevant data
TEPCSP_AreaL.df = subset(TEPCSP_AreaL.df, Fraction!="0.2 filtered")
TEPCSP_AreaL.df = subset(TEPCSP_AreaL.df, Condition!="Unstained")

#Plot data
Particle_AreaL.plot = ggplot(TEPCSP_AreaL.df, 
                             aes(y = CorrAreaL, 
                                 x = Station, 
                                 colour = Fraction, 
                                 fill = Fraction,
                                 group = Fraction)) +
  geom_bar(stat = "identity", position = "dodge")+
  #scale_y_log10()+
  geom_errorbar(aes(ymin=(CorrAreaL-se), 
                    ymax=(CorrAreaL+se)),
                position=position_dodge(0.9),
                size = 1,
                width = 0.5, 
                colour = "grey25"
                )+
  facet_grid(Date ~ Condition)+
  scale_color_manual("Particle fraction", values = FractionColourList)+
  scale_fill_manual("Particle fraction", values = FractionColourList)+
  theme_bw() +
  My_Theme +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ylab(expression(Particle~concentration~"(Âµm"^2~L^"-1"*")"))
Particle_AreaL.plot

#plotly::ggplotly(Particle_AreaL.plot)

#Save plot
#tiff("C:/Users/hunefeldt/OneDrive/Desktop/R_analysis/ParticleAnalysis/2022_01_analysis/Particle_AreaL.tiff", units = "in", width = 12, height = 8, res = 120)
#Particle_AreaL.plot
#dev.off()



```

```{r Basic particle percentage of TEP and CSP plot}
#Subset to relevant data
TEPCSP_Particles.df = subset(na.omit(Brightfield_sum_V1.df), Condition=="TEP" | Condition=="CSP")
Unstained_Particles.df = subset(na.omit(Brightfield_sum_V1.df), Condition == "Unstained")

#Summarise plots for easier calculations
Unstained_sum.df = Rmisc::summarySE(Unstained_Particles.df, 
                            measurevar="CorrAreaL", 
                            groupvars=c("Date",
                                        "Station", 
                                        "Condition",
                                        "Fraction"),
                            na.rm = T)
TEP_CSP_sum.df = Rmisc::summarySE(TEPCSP_Particles.df, 
                            measurevar="CorrAreaL", 
                            groupvars=c("Date", 
                                        "Station", 
                                        "Condition",
                                        "Fraction"),
                            na.rm = T)

#Convert to scientific scale
#Unstained_Particles.df$CorrAreaL = scales::scientific(Unstained_Particles.df$CorrAreaL, digits = 3)
#TEPCSP_Particles.df$CorrAreaL = scales::scientific(TEPCSP_Particles.df$CorrAreaL, digits = 3)

#Calculate TotalParticle Area based on unstained + stained particle numbers

i=1
x=i
y=3

Unstained_sum.df$TotalParticleArea = 0

#Get total particle numbers: unstained + TEP + CSP
for (i in 1:length(Unstained_sum.df$Station)) { 
  for (x in 1:length(TEP_CSP_sum.df$Station)) {
    for (y in 1:length(TEP_CSP_sum.df$Station)) {
  #Match conditions
    if (grepl(Unstained_sum.df$Station[i],TEP_CSP_sum.df$Station[x] ) == T &
        grepl(Unstained_sum.df$Station[i],TEP_CSP_sum.df$Station[y] ) == T &
        grepl(Unstained_sum.df$Date[i],TEP_CSP_sum.df$Date[x] ) == T & 
        grepl(Unstained_sum.df$Date[i],TEP_CSP_sum.df$Date[y] ) == T & 
        grepl(Unstained_sum.df$Fraction[i],TEP_CSP_sum.df$Fraction[x]) == T &
        grepl(Unstained_sum.df$Fraction[i],TEP_CSP_sum.df$Fraction[y]) == T &
        grepl(TEP_CSP_sum.df$Condition[x], "TEP") == T &
        grepl(TEP_CSP_sum.df$Condition[y], "CSP") == T) {
      
      #Calculate total particle numbers
      Unstained_sum.df$TotalParticleArea[i] = Unstained_sum.df$CorrAreaL[i] +
        TEP_CSP_sum.df$CorrAreaL[x] +  # TEP
        TEP_CSP_sum.df$CorrAreaL[y]    # CSP
 
    }
  
  
}}
  
  
}

#Manually do Meedem Grund      2022.02 Suspended TEP: as no CSP.
tmp = subset(Unstained_sum.df, Station =="Meedem Grund" & Date == "2022.02" & Fraction == "Suspended")$CorrAreaL +
  subset(TEP_CSP_sum.df, Station =="Meedem Grund" & Date == "2022.02" & Fraction == "Suspended")$CorrAreaL
#Replace with calculate value - make sure it is the row with 0 in it, due to a row duplication error
Unstained_sum.df[11,10] 
Unstained_sum.df[11,10] = tmp



i=10
TEP_CSP_sum.df$TotalParticleArea = 0
TEP_CSP_sum.df$ConditionPerc = 0

for (i in 1:length(TEP_CSP_sum.df$Station)) {
  
  StationID=TEP_CSP_sum.df$Station[i]
  StainID=TEP_CSP_sum.df$Condition[i]
  FractionID=TEP_CSP_sum.df$Fraction[i]
  DateID=TEP_CSP_sum.df$Date[i]
  
  #For record keeping and in case of error
  print(paste0(DateID, StationID, StainID, FractionID))
  
  #Extract total particle number that we previously calculated
  Control_mean = subset(Unstained_sum.df, Date==DateID & Station==StationID & Fraction==FractionID)$TotalParticleArea
    
  #Calculate the relative percentage of TEP or CSP
  tmp = TEP_CSP_sum.df$CorrAreaL[i] / Control_mean * 100
  #Make sure its in a numeric format for downstream analysis
  TEP_CSP_sum.df$ConditionPerc[i] = as.numeric(as.character(tmp))
  #Record total particle area for record keeping
  TEP_CSP_sum.df$TotalParticleArea[i] = Control_mean
  
    
}

#Sanity check
CorrectionSpread = TEP_CSP_sum.df %>%
  group_by(Station, Date, Fraction, Condition) %>%
  dplyr::summarise(mean_val = mean(ConditionPerc), median = median(ConditionPerc), max = max(ConditionPerc))
print(CorrectionSpread, n = 100)



#Plot data
Particle_TEPCSPPerc.plot = ggplot(TEP_CSP_sum.df, aes(y = ConditionPerc, x = Station, colour = Fraction, group = Fraction)) +
  geom_smooth(size = 1)+
  #geom_line(aes(y=TotalParticleArea, linetype = "dotted"), size = 1)+
  #scale_y_log10()+
  #geom_errorbar(aes(ymin=(ConditionPerc-ci), 
   #                 ymax=(ConditionPerc+ci), 
    #                colour = Fraction),
                #position=pd,
     #           size = 1,
      #          width = 0.5
       #         )+
  facet_grid(Date ~ Condition)+
  scale_color_manual("Particle fraction", values = cbbPalette)+
  theme_bw() +
  My_Theme +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ylab("TEP and CSP area \nof particles (%)")
Particle_TEPCSPPerc.plot

#Save plot
#tiff("C:/Users/hunefeldt/OneDrive/Desktop/R_analysis/ParticleAnalysis/2022_01_analysis/Particle_PercofTotal.tiff", units = "in", width = 12, height = 8, res = 120)
#Particle_TEPCSPPerc.plot
#dev.off()


```

```{r Combined Stained area per Litre and stained percentage plot}

####Combine dataframes####
TEP_CSP_sum.df$Stromkilometer = TEP_CSP_sum.df$Station

#Get distance from Hamburg/Elbe distance for spearman tests
TEP_CSP_sum.df$Stromkilometer = gsub("Muhlenberger Loch", 633, TEP_CSP_sum.df$Stromkilometer)
TEP_CSP_sum.df$Stromkilometer = gsub("Twielenfleth", 651, TEP_CSP_sum.df$Stromkilometer)
TEP_CSP_sum.df$Stromkilometer = gsub("Schwarztonnensand", 665, TEP_CSP_sum.df$Stromkilometer)
TEP_CSP_sum.df$Stromkilometer = gsub("Brunsbuttel", 694, TEP_CSP_sum.df$Stromkilometer)
TEP_CSP_sum.df$Stromkilometer = gsub("Meedem Grund", 712, TEP_CSP_sum.df$Stromkilometer)
TEP_CSP_sum.df = subset(TEP_CSP_sum.df, Station!="NEGATIVE" & Station!="BunthausSpitze")


TEP_CSP_sum.df$Stromkilometer = as.numeric(as.character(TEP_CSP_sum.df$Stromkilometer))

#Summarise TEP and CSP % for subsequent plot
TEP_CSP_sum2.df = Rmisc::summarySE(TEP_CSP_sum.df, 
                            measurevar="ConditionPerc", 
                            groupvars=c("Date", 
                                        "Station", 
                                        "Stromkilometer",
                                        "Condition",
                                        "Fraction"),
                            na.rm = T)


#Make sure names match for the same variables
colnames(TEPCSP_AreaL.df)
colnames(TEP_CSP_sum2.df)

#Compare dimensions
dim(TEPCSP_AreaL.df)
dim(TEP_CSP_sum2.df)


#Merge two dataframes
Merged_Fig.df = merge(TEPCSP_AreaL.df, TEP_CSP_sum2.df, by = c("Station", "Condition", "Date", "Fraction"))



#Rename date column for compliance with other code
Merged_Fig.df$Sample_date = Merged_Fig.df$Date
Merged_Fig.df$Date = NULL


#Fix date format for easier plotting
Merged_Fig.df$Sample_date = gsub("2021.07", "Jul 21", Merged_Fig.df$Sample_date)
Merged_Fig.df$Sample_date = gsub("2021.11", "Nov 21", Merged_Fig.df$Sample_date)
Merged_Fig.df$Sample_date = gsub("2022.02", "Feb 22", Merged_Fig.df$Sample_date)
Merged_Fig.df$Sample_date = gsub("2022.05", "May 22", Merged_Fig.df$Sample_date)
Merged_Fig.df$Sample_date = gsub("2022.06", "Jun 22", Merged_Fig.df$Sample_date)
Merged_Fig.df$Sample_date = gsub("2022.11", "Nov 22", Merged_Fig.df$Sample_date)


Merged_Fig.df$Sample_date = factor(Merged_Fig.df$Sample_date,
                                              levels = c("Jul 21",
                                                         "Feb 22",
                                                         "May 22",
                                                         "Jun 22",
                                                         "Nov 22"))

#Set order to consistency
Merged_Fig.df$Fraction = factor(Merged_Fig.df$Fraction,
                                              levels = c("Suspended",
                                                         "Sinking"))

####Plot ####
# Value used to transform the data
coeff <- 300000000

#Remove November 2021 Land cruise 
Merged_Fig.df = subset(Merged_Fig.df, Sample_date!="Nov-21" & Sample_date!="Jul-21")


Figure.plot = ggplot(Merged_Fig.df, aes(x=Stromkilometer, 
                                       fill = Fraction, 
                                       group = Fraction)) +
  geom_bar(aes(y=as.numeric(CorrAreaL, 
                            fill=Fraction, 
                            colour = Fraction,
                            group = Fraction),), 
            stat="identity", 
            position = "dodge") +
  geom_errorbar(aes(ymin=(CorrAreaL - se.x), 
                    ymax=(CorrAreaL + se.x)),
                position = position_dodge(0.9),
                size = 1,
                width = 0.5, 
                colour = "grey25"
                )+
  geom_line(aes(y = ConditionPerc * coeff, 
                 colour = Fraction, 
                 group = Fraction), 
            size=2) +
  geom_errorbar(aes(ymin=((ConditionPerc - se.y) * coeff), 
                    ymax=((ConditionPerc + se.y) * coeff), 
                    colour = Fraction),
                #position=pd,
                size = 1,
                width = 0.5
                )+
  xlab("Elbe km")+
  scale_y_continuous(
    name = expression(Particle~conc.~"(Âµm"^2*L^"-1"*")"), # Features of the first axis
    sec.axis = sec_axis(~./coeff, 
                        name="Particle contrib. (%)",
                        breaks = c(0,25,50,75)),
    breaks = c(0.0e+00,1.0e+10,2.0e+10)) +     # Add a second axis and specify its features
  scale_fill_manual("Particle \nconc. \nfractions", values = FractionColourList)+
  scale_colour_manual("Particle \ncontr. \nfractions", values = FractionSecondaryColourList)+
  #guides(colour = "none")+
  facet_grid(Sample_date ~ Condition)+
  scale_x_reverse()+
  Poster_Theme+
  theme(axis.text.x = element_text(angle = 45, 
                                   hjust = 1),
        legend.position = "bottom")

Figure1B.plot

#tiff("YOU/PATH/HERE/Poster/TEPCSP_ParticleConcperL_Perc.tiff", units = "cm", width = 24, height = 18, res = 120)
#Figure.plot
#dev.off()

pdf("/YOUR/PATH/HERE/TEPCSP_ParticleConcperL_Perc.pdf", height = 7, width = 18)
Figure.plot
dev.off()

```


```{r TEP/CSP mean values and trends}
test_mean = Merged_Fig.df %>% 
  dplyr::group_by(Sample_date, Condition) %>% 
  dplyr::summarise(#sum_val = sum(Abundance),
                   mean_Perc = mean(as.numeric(ConditionPerc)), 
                   sd_Perc = sd(as.numeric(ConditionPerc)),
                   mean_PA = mean(as.numeric(CorrAreaL)), 
                   sd_PA = sd(as.numeric(CorrAreaL)))
print(test_mean)

test_mean$Sample_date = factor(test_mean$Sample_date,
                               levels = c("Jul-21",
                                          "Feb 22",
                                          "May 22",
                                          "Jun 22",
                                          "Nov 22"))

ggplot(data = test_mean, aes(x = Sample_date, y = mean_PA, colour = Condition, group = Condition))+
  geom_line()

```


```{r Statistics for Figure}
#Add season data
TEP_CSP_sum.df$Season = TEP_CSP_sum.df$Date
TEP_CSP_sum.df$Season = gsub("2021.07", "Summer", TEP_CSP_sum.df$Season)
TEP_CSP_sum.df$Season = gsub("2021.11", "Autumn", TEP_CSP_sum.df$Season)
TEP_CSP_sum.df$Season = gsub("2022.02", "Winter", TEP_CSP_sum.df$Season)
TEP_CSP_sum.df$Season = gsub("Â´2022.05", "Spring", TEP_CSP_sum.df$Season)
TEP_CSP_sum.df$Season = gsub("2022.06", "Summer", TEP_CSP_sum.df$Season)
TEP_CSP_sum.df$Season = gsub("2022.11", "Autumn", TEP_CSP_sum.df$Season)

#Add salinity
Salinity.df = Physico_para.df[c(4,6,7,8,11)]

Salinity.df$Fraction = Salinity.df$Sample_type
Salinity.df$Sample_type = NULL
Salinity.df$Fraction = gsub("Light_fraction", "Suspended", Salinity.df$Fraction)
Salinity.df$Fraction = gsub("Heavy_fraction", "Sinking", Salinity.df$Fraction)
Salinity.df$Fraction = gsub("Free_living", "Total", Salinity.df$Fraction)
Salinity.df$Fraction = factor(Salinity.df$Fraction,
                                              levels = c("Total",
                                                         "Suspended",
                                                         "Sinking"))
Salinity.df = subset(Salinity.df, Fraction!="Total")

Salinity.df$Sample_date = factor(Salinity.df$Sample_date,
                                              levels = c("May-21",
                                                         "Jul-21",
                                                         "Nov-21",
                                                         "Feb 22",
                                                         "May 22",
                                                         "Jun 22",
                                                         "Nov 22"))


#Fix date format for easier plotting
TEP_CSP_sum.df$Sample_date = TEP_CSP_sum.df$Date
TEP_CSP_sum.df$Date = NULL
TEP_CSP_sum.df$Sample_date = gsub("2021.07", "Jul-21", TEP_CSP_sum.df$Sample_date)
TEP_CSP_sum.df$Sample_date = gsub("2021.11", "Nov-21", TEP_CSP_sum.df$Sample_date)
TEP_CSP_sum.df$Sample_date = gsub("2022.02", "Feb 22", TEP_CSP_sum.df$Sample_date)
TEP_CSP_sum.df$Sample_date = gsub("2022.05", "May 22", TEP_CSP_sum.df$Sample_date)
TEP_CSP_sum.df$Sample_date = gsub("2022.06", "Jun 22", TEP_CSP_sum.df$Sample_date)
TEP_CSP_sum.df$Sample_date = gsub("2022.11", "Nov 22", TEP_CSP_sum.df$Sample_date)

colnames(Salinity.df)
colnames(TEP_CSP_sum.df)
TEP_CSP_sum.df = merge(TEP_CSP_sum.df, Salinity.df, by = c("Station", "Stromkilometer", "Sample_date", "Fraction"))

####Processed data fraction differences####
#Separate TEP and CSP
TEP_sum.df = subset(TEP_CSP_sum.df, Condition == "TEP")
CSP_sum.df = subset(TEP_CSP_sum.df, Condition == "CSP")

#Numeric differences between fractions
Sum.df = TEP_sum.df %>%
  group_by(Fraction) %>%
  dplyr::summarise(mean_val = mean(CorrAreaL), sd = sd(CorrAreaL))
print(Sum.df)
#Sinking / suspended
Sum.df[2,2] / Sum.df[1,2]
Sum.df = CSP_sum.df %>%
  group_by(Fraction) %>%
  dplyr::summarise(mean_val = mean(CorrAreaL), sd = sd(CorrAreaL))
print(Sum.df)
#Suspended / sinking
Sum.df[1,2] / Sum.df[2,2]

#Test for significance
wilcox.test(subset(TEP_sum.df, Fraction == "Suspended")$CorrAreaL, subset(TEP_sum.df, Fraction == "Sinking")$CorrAreaL)
wilcox.test(subset(CSP_sum.df, Fraction == "Suspended")$CorrAreaL, subset(CSP_sum.df, Fraction == "Sinking")$CorrAreaL)



####Unprocessed data fraction differences####

#Separate TEP and CSP
TEP.df = subset(TEPCSP_Particles.df, Condition == "TEP")
CSP.df = subset(TEPCSP_Particles.df, Condition == "CSP")

#Numeric differences between fractions
Sum.df = TEP.df %>%
  group_by(Fraction) %>%
  dplyr::summarise(mean_val = mean(CorrAreaL), sd = sd(CorrAreaL))
print(Sum.df)
Sum.df[2,2] / Sum.df[1,2]
Sum.df = CSP.df %>%
  group_by(Fraction) %>%
  dplyr::summarise(mean_val = mean(CorrAreaL), sd = sd(CorrAreaL))
print(Sum.df)

Sum.df[2,2] / Sum.df[1,2]

#Test for significance
wilcox.test(subset(TEPCSP_Particles.df, Condition == "TEP" & Fraction == "Suspended")$CorrAreaL, subset(TEPCSP_Particles.df, Condition == "TEP" & Fraction == "Sinking")$CorrAreaL)
wilcox.test(subset(TEPCSP_Particles.df, Condition == "CSP" & Fraction == "Suspended")$CorrAreaL, subset(TEPCSP_Particles.df, Condition == "CSP" & Fraction == "Sinking")$CorrAreaL)


####Seasonal TEP and CSP differences####
Sum.df = TEP_sum.df %>%
  group_by(Date, Fraction) %>%
  dplyr::summarise(mean_val = mean(CorrAreaL), sd = sd(CorrAreaL))
print(Sum.df)

ggplot(Sum.df, aes(x = Date, y = mean_val, colour = Fraction, group = Fraction)) +
  geom_line(size = 1)+
  ggtitle("TEP")


Sum.df = CSP_sum.df %>%
  group_by(Date, Fraction) %>%
  dplyr::summarise(mean_val = mean(CorrAreaL), sd = sd(CorrAreaL))
print(Sum.df)

ggplot(Sum.df, aes(x = Date, y = mean_val, colour = Fraction, group = Fraction)) +
  geom_line(size = 1)+
  ggtitle("CSP")


Sum.df = TEP_CSP_sum.df %>%
  group_by(Date) %>%
  dplyr::summarise(mean_val = mean(CorrAreaL), sd = sd(CorrAreaL))
print(Sum.df)

ggplot(Sum.df, aes(x = Date, y = mean_val )) +
  geom_line(size = 1)



####TEP and CSP differences along the Elbe####
Sum.df = TEP_sum.df %>%
  group_by(Station, Fraction) %>%
  dplyr::summarise(mean_val = mean(CorrAreaL), sd = sd(CorrAreaL))
print(Sum.df)

ggplot(Sum.df, aes(x = Station, y = mean_val, colour = Fraction, group = Fraction)) +
  geom_line(size = 1)

cor.test(TEP_sum.df$CorrAreaL, TEP_sum.df$Stromkilometer, method = "s")
cor.test(TEP_sum.df$CorrAreaL, as.numeric(TEP_sum.df$Salinity), method = "s")

TEP_mgperL_model = aov(CorrAreaL ~ Stromkilometer, data = TEP_sum.df)
summary(TEP_mgperL_model)
rstatix::eta_squared(TEP_mgperL_model)

Sum.df = CSP_sum.df %>%
  group_by(Station, Fraction) %>%
  dplyr::summarise(mean_val = mean(CorrAreaL), sd = sd(CorrAreaL))
print(Sum.df)

ggplot(Sum.df, aes(x = Station, y = mean_val, colour = Fraction, group = Fraction)) +
  geom_line(size = 1)

cor.test(CSP_sum.df$CorrAreaL, CSP_sum.df$Stromkilometer, method = "s")
cor.test(CSP_sum.df$CorrAreaL, as.numeric(CSP_sum.df$Salinity), method = "s")







####Exopolymer : Particle size ####
Merged_Fig_TEP.df = subset(Merged_Fig.df, Condition=="TEP")
Merged_Fig_CSP.df = subset(Merged_Fig.df, Condition=="CSP")

cor.test(Merged_Fig.df$CorrAreaL[-13], Merged_Fig_TEP.df$ConditionPerc, method = "p")
cor.test(Merged_Fig.df$CorrAreaL[-c(13,15)], Merged_Fig_CSP.df$ConditionPerc, method = "p")

####Single variables####

#Significant differences over station - TEP
TEP_mgperL_model = aov(CorrAreaL ~ Station, data = TEP_sum.df)
summary(TEP_mgperL_model)
rstatix::eta_squared(TEP_mgperL_model)

#Significant differences over station - TEP %
TEP_Perc_model = aov(ConditionPerc ~ Station, data = TEP_sum.df)
summary(TEP_Perc_model)
rstatix::eta_squared(TEP_Perc_model)

#Significant differences over station - CSP
CSP_mgperL_model = aov(CorrAreaL ~ Station, data = CSP_sum.df)
summary(CSP_mgperL_model)
rstatix::eta_squared(CSP_mgperL_model)

#Significant differences over station - CSP %
CSP_Perc_model = aov(ConditionPerc ~ Station, data = CSP_sum.df)
summary(CSP_Perc_model)
rstatix::eta_squared(CSP_Perc_model)


#Significant differences over Season - TEP
TEP_mgperL_model = aov(CorrAreaL ~ Season, data = TEP_sum.df)
summary(TEP_mgperL_model)
rstatix::eta_squared(TEP_mgperL_model)

#Significant differences over Season - TEP %
TEP_Perc_model = aov(ConditionPerc ~ Season, data = TEP_sum.df)
summary(TEP_Perc_model)
rstatix::eta_squared(TEP_Perc_model)

#Significant differences over Season - CSP
CSP_mgperL_model = aov(CorrAreaL ~ Season, data = CSP_sum.df)
summary(CSP_mgperL_model)
rstatix::eta_squared(CSP_mgperL_model)

#Significant differences over Season - CSP %
CSP_Perc_model = aov(ConditionPerc ~ Season, data = CSP_sum.df)
summary(CSP_Perc_model)
rstatix::eta_squared(CSP_Perc_model)


#Significant differences over Date - TEP
TEP_mgperL_model = aov(CorrAreaL ~ Date, data = TEP_sum.df)
summary(TEP_mgperL_model)
rstatix::eta_squared(TEP_mgperL_model)

#Significant differences over Date - TEP %
TEP_Perc_model = aov(ConditionPerc ~ Date, data = TEP_sum.df)
summary(TEP_Perc_model)
rstatix::eta_squared(TEP_Perc_model)

#Significant differences over Date - CSP
CSP_mgperL_model = aov(CorrAreaL ~ Date, data = CSP_sum.df)
summary(CSP_mgperL_model)
rstatix::eta_squared(CSP_mgperL_model)

#Significant differences over Date - CSP %
CSP_Perc_model = aov(ConditionPerc ~ Date, data = CSP_sum.df)
summary(CSP_Perc_model)
rstatix::eta_squared(CSP_Perc_model)


#Significant differences over Fraction - TEP
TEP_mgperL_model = aov(CorrAreaL ~ Fraction, data = TEP_sum.df)
summary(TEP_mgperL_model)
rstatix::eta_squared(TEP_mgperL_model)

#Significant differences over Fraction - TEP %
TEP_Perc_model = aov(ConditionPerc ~ Fraction, data = TEP_sum.df)
summary(TEP_Perc_model)
rstatix::eta_squared(TEP_Perc_model)

#Significant differences over Fraction - CSP
CSP_mgperL_model = aov(CorrAreaL ~ Fraction, data = CSP_sum.df)
summary(CSP_mgperL_model)
rstatix::eta_squared(CSP_mgperL_model)

#Significant differences over Fraction - CSP %
CSP_Perc_model = aov(ConditionPerc ~ Fraction, data = CSP_sum.df)
summary(CSP_Perc_model)
rstatix::eta_squared(CSP_Perc_model)

####Interactions####

#Significant differences over station and Season - TEP
TEP_mgperL_model = aov(CorrAreaL ~ Station * Season, data = TEP_sum.df)
summary(TEP_mgperL_model)
rstatix::eta_squared(TEP_mgperL_model)

#Significant differences over station and Season - TEP %
TEP_Perc_model = aov(ConditionPerc ~ Station * Season, data = TEP_sum.df)
summary(TEP_Perc_model)
rstatix::eta_squared(TEP_Perc_model)

#Significant differences over station and Season- CSP
CSP_mgperL_model = aov(CorrAreaL ~ Station * Season, data = CSP_sum.df)
summary(CSP_mgperL_model)
rstatix::eta_squared(CSP_mgperL_model)

#Significant differences over station and Season - CSP %
CSP_Perc_model = aov(ConditionPerc ~ Station * Season, data = CSP_sum.df)
summary(CSP_Perc_model)
rstatix::eta_squared(CSP_Perc_model)


#Significant differences over station and Date - TEP
TEP_mgperL_model = aov(CorrAreaL ~ Station * Date, data = TEP_sum.df)
summary(TEP_mgperL_model)
rstatix::eta_squared(TEP_mgperL_model)

#Significant differences over station and Date - TEP %
TEP_Perc_model = aov(ConditionPerc ~ Station * Date, data = TEP_sum.df)
summary(TEP_Perc_model)
rstatix::eta_squared(TEP_Perc_model)

#Significant differences over station and Date- CSP
CSP_mgperL_model = aov(CorrAreaL ~ Station * Date, data = CSP_sum.df)
summary(CSP_mgperL_model)
rstatix::eta_squared(CSP_mgperL_model)

#Significant differences over station and Date - CSP %
CSP_Perc_model = aov(ConditionPerc ~ Station * Date, data = CSP_sum.df)
summary(CSP_Perc_model)
rstatix::eta_squared(CSP_Perc_model)


#Significant differences over station and Fraction - TEP
TEP_mgperL_model = aov(CorrAreaL ~ Station * Fraction, data = TEP_sum.df)
summary(TEP_mgperL_model)
rstatix::eta_squared(TEP_mgperL_model)

#Significant differences over station and Fraction - TEP %
TEP_Perc_model = aov(ConditionPerc ~ Station * Fraction, data = TEP_sum.df)
summary(TEP_Perc_model)
rstatix::eta_squared(TEP_Perc_model)

#Significant differences over station and Fraction- CSP
CSP_mgperL_model = aov(CorrAreaL ~ Station * Fraction, data = CSP_sum.df)
summary(CSP_mgperL_model)
rstatix::eta_squared(CSP_mgperL_model)

#Significant differences over station and Fraction - CSP %
CSP_Perc_model = aov(ConditionPerc ~ Station * Fraction, data = CSP_sum.df)
summary(CSP_Perc_model)
rstatix::eta_squared(CSP_Perc_model)


#Significant differences over Season and Fraction - TEP
TEP_mgperL_model = aov(CorrAreaL ~ Season * Fraction, data = TEP_sum.df)
summary(TEP_mgperL_model)
rstatix::eta_squared(TEP_mgperL_model)

#Significant differences over Season and Fraction - TEP %
TEP_Perc_model = aov(ConditionPerc ~ Season * Fraction, data = TEP_sum.df)
summary(TEP_Perc_model)
rstatix::eta_squared(TEP_Perc_model)

#Significant differences over Season and Fraction- CSP
CSP_mgperL_model = aov(CorrAreaL ~ Season * Fraction, data = CSP_sum.df)
summary(CSP_mgperL_model)
rstatix::eta_squared(CSP_mgperL_model)

#Significant differences over Season and Fraction - CSP %
CSP_Perc_model = aov(ConditionPerc ~ Season * Fraction, data = CSP_sum.df)
summary(CSP_Perc_model)
rstatix::eta_squared(CSP_Perc_model)


#Significant differences over Date and Fraction - TEP
TEP_mgperL_model = aov(CorrAreaL ~ Date * Fraction, data = TEP_sum.df)
summary(TEP_mgperL_model)
rstatix::eta_squared(TEP_mgperL_model)

#Significant differences over Date and Fraction - TEP %
TEP_Perc_model = aov(ConditionPerc ~ Date * Fraction, data = TEP_sum.df)
summary(TEP_Perc_model)
rstatix::eta_squared(TEP_Perc_model)

#Significant differences over Date and Fraction- CSP
CSP_mgperL_model = aov(CorrAreaL ~ Date * Fraction, data = CSP_sum.df)
summary(CSP_mgperL_model)
rstatix::eta_squared(CSP_mgperL_model)

#Significant differences over Date and Fraction - CSP %
CSP_Perc_model = aov(ConditionPerc ~ Date * Fraction, data = CSP_sum.df)
summary(CSP_Perc_model)
rstatix::eta_squared(CSP_Perc_model)



#Significant differences over station, Season and fraction - TEP
TEP_mgperL_model = aov(CorrAreaL ~ Station * Season * Fraction, data = TEP_sum.df)
summary(TEP_mgperL_model)
rstatix::eta_squared(TEP_mgperL_model)

#Significant differences over station, Season and fraction - TEP %
TEP_Perc_model = aov(ConditionPerc ~ Station * Season * Fraction, data = TEP_sum.df)
summary(TEP_Perc_model)
rstatix::eta_squared(TEP_Perc_model)

#Significant differences over station, Season and fraction - CSP
CSP_mgperL_model = aov(CorrAreaL ~ Station * Season * Fraction, data = CSP_sum.df)
summary(CSP_mgperL_model)
rstatix::eta_squared(CSP_mgperL_model)

#Significant differences over station, Season and fraction - CSP %
CSP_Perc_model = aov(ConditionPerc ~ Station * Season * Fraction, data = CSP_sum.df)
summary(CSP_Perc_model)
rstatix::eta_squared(CSP_Perc_model)


#Significant differences over station, Date and fraction - TEP
TEP_mgperL_model = aov(CorrAreaL ~ Station * Date * Fraction, data = TEP_sum.df)
summary(TEP_mgperL_model)
rstatix::eta_squared(TEP_mgperL_model)

#Significant differences over station, Date and fraction - TEP %
TEP_Perc_model = aov(ConditionPerc ~ Station * Date * Fraction, data = TEP_sum.df)
summary(TEP_Perc_model)
rstatix::eta_squared(TEP_Perc_model)

#Significant differences over station, Date and fraction - CSP
CSP_mgperL_model = aov(CorrAreaL ~ Station * Date * Fraction, data = CSP_sum.df)
summary(CSP_mgperL_model)
rstatix::eta_squared(CSP_mgperL_model)

#Significant differences over station, Date and fraction - CSP %
CSP_Perc_model = aov(ConditionPerc ~ Station * Date * Fraction, data = CSP_sum.df)
summary(CSP_Perc_model)
rstatix::eta_squared(CSP_Perc_model)


####Between Perc. and Area####


#Correlation between TEP area and TEP %
cor.test(as.numeric(TEP_sum.df$CorrAreaL), TEP_sum.df$ConditionPerc, method = "spearman")

#Correlation between CSP area and CSP %
cor.test(as.numeric(CSP_sum.df$CorrAreaL), CSP_sum.df$ConditionPerc, method = "spearman")

#Correlation between TEP area and salinity


#Correlation between TEP % and salinity


#Correlation between CSP area and salinity


#Correlation between CSP % and salinity






```

#Figure 3 Salinity and Turbidity
##Salinity
```{r}

####Prepare df####
Physico_para.df = read.csv("YOU/PATH/HERE/Data/PhysicochemicalParameters_mod_BU.txt", encoding = "UTF-8", sep = "\t")

Water_physico_para.df = unique(Physico_para.df[,c(4:6,8:14,16:31)])


Salinity.df = Rmisc::summarySE(Water_physico_para.df, 
                             measurevar="Salinity_PSU", 
                             groupvars=c("Sample_date",
                                         "Stromkilometer"),
                             na.rm = T)



Salinity.df = subset(Salinity.df, Stromkilometer > 610 & Sample_date!="May 21")


Salinity.df$Sample_date = factor(Salinity.df$Sample_date,
                             levels = c("Jul 21", 
                                        "Feb 22",
                                        "May 22",
                                        "Jun 22",
                                        "Nov 22"))

Salinity.plt = ggplot(Salinity.df, 
                   aes_string(x = "Stromkilometer",
                       y = "Salinity_PSU",
                       colour = "Sample_date",
                       group = "Sample_date"
                 )) +
    geom_line(size = 2)+
    geom_point()+
    ylab("Salinity (PSU)")+
    xlab("Elbe km")+
    scale_x_reverse()+
    scale_color_manual("Sample Date", values = cbbPalette)+
    My_Theme +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

Salinity.plt

test_mean = Salinity.df %>% 
  dplyr::group_by(Stromkilometer) %>% 
  dplyr::summarise(mean_SPM = mean(as.numeric(Salinity_PSU)), 
                   sd_SPM = sd(as.numeric(Salinity_PSU)))
print(test_mean)



```

##Turbidity
```{r}

####Prepare df####
Physico_para.df = read.csv("YOU/PATH/HERE/Data/PhysicochemicalParameters_mod.txt", encoding = "UTF-8", sep = "\t")

Water_physico_para.df = unique(Physico_para.df[,c(4:6,8:14,16:31)])


Turbidity.df = Rmisc::summarySE(Water_physico_para.df, 
                             measurevar="Turbidity_NTU", 
                             groupvars=c("Sample_date",
                                         "Stromkilometer"),
                             na.rm = T)


Turbidity.df = subset(Turbidity.df, Stromkilometer > 610 & Sample_date!="May 21")


Turbidity.df$Sample_date = factor(Turbidity.df$Sample_date,
                             levels = c("Jul 21", 
                                        "Feb 22",
                                        "May 22",
                                        "Jun 22",
                                        "Nov 22"))


Turbidity.plt = ggplot(Turbidity.df, 
                   aes_string(x = "Stromkilometer",
                       y = "Turbidity_NTU",
                       colour = "Sample_date",
                       group = "Sample_date"
                 )) +
    geom_line(size = 2)+
    geom_point()+
    ylab("Turbidity (PSU)")+
    xlab("Elbe km")+
    scale_x_reverse()+
    scale_color_manual("Sample Date", values = cbbPalette)+
    My_Theme +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

Turbidity.plt


```
##Combine water condition plots
```{r}



tiff("/YOUR/PATH/HERE/Figure3_SalinityTurbidity.tiff", units = "in", width = 7, height = 8, res = 150)

ggarrange(Salinity.plt, Turbidity.plt,
          common.legend = T,
          nrow = 2,
          labels = "AUTO",
          legend = "right")

dev.off()

```
#Figure 4 - Visible Particle + Dry weight differences 
```{r Basic SPM plot}

Physico_para.df = read.csv("YOU/PATH/HERE/Data/PhysicochemicalParameters_mod.txt", encoding = "UTF-8", sep = "\t")
Particle_physico_para.df = unique(Physico_para.df[,c(4:8,10,11,15)])

Particle_physico_para.df = subset(Particle_physico_para.df, !Sample_date=="Nov 21")

Particle_physico_para.df$Stromkilometer = Particle_physico_para.df$Station

#Get distance from Hamburg/Elbe distance for spearman tests
Particle_physico_para.df$Stromkilometer = gsub("Muhlenberger Loch", 633, Particle_physico_para.df$Stromkilometer)
Particle_physico_para.df$Stromkilometer = gsub("Twielenfleth", 651, Particle_physico_para.df$Stromkilometer)
Particle_physico_para.df$Stromkilometer = gsub("Schwarztonnensand", 665, Particle_physico_para.df$Stromkilometer)
Particle_physico_para.df$Stromkilometer = gsub("Brunsbuttel", 694, Particle_physico_para.df$Stromkilometer)
Particle_physico_para.df$Stromkilometer = gsub("Meedem Grund", 712, Particle_physico_para.df$Stromkilometer)
Particle_physico_para.df = subset(Particle_physico_para.df, Station!="NEGATIVE" & Station!="BunthausSpitze")


Particle_physico_para.df$Stromkilometer = as.numeric(as.character(Particle_physico_para.df$Stromkilometer))

Particle_physico_para.df$Station = factor(Particle_physico_para.df$Station,
                             levels = c("Meedem Grund", 
                                        "Brunsbuttel",
                                        #"Kollmar",
                                        "Schwarztonnensand",
                                        "Twielenfleth",
                                        "Muhlenberger Loch"#,
                                        #"SeemanshÃ¶ft"
                                        ))
Particle_physico_para.df$Fraction = Particle_physico_para.df$Sample_type
Particle_physico_para.df$Sample_type = NULL
Particle_physico_para.df$Fraction = gsub("Light_fraction", "Suspended", Particle_physico_para.df$Fraction)
Particle_physico_para.df$Fraction = gsub("Heavy_fraction", "Sinking", Particle_physico_para.df$Fraction)
Particle_physico_para.df$Fraction = gsub("Free_living", "Total", Particle_physico_para.df$Fraction)
Particle_physico_para.df$Fraction = factor(Particle_physico_para.df$Fraction,
                                              levels = c("Total",
                                                         "Suspended",
                                                         "Sinking"))
Particle_physico_para.df = subset(Particle_physico_para.df, Fraction!="Total")

Particle_physico_para.df$Sample_date = factor(Particle_physico_para.df$Sample_date,
                                              levels = c("May 21",
                                                         "Jul 21",
                                                         "Nov 21",
                                                         "Feb 22",
                                                         "May 22",
                                                         "Jun 22",
                                                         "Nov 22"))

Particle_physico_para_SPM_mgperL = ggplot(Particle_physico_para.df, 
                            aes(x = Stromkilometer,
                                y = as.numeric(SPM_mgperL),
                                fill = Fraction
                                )) + 
  geom_bar(position = "dodge", stat = "identity")+
 #geom_point()+
  #scale_y_log10()+
  facet_grid(Sample_date ~ . )+
  theme_bw()+
  ylab("Dry weight \n(mg / L)")+
  scale_color_manual("Dry weight Fraction", values = cbbPalette)+
  My_Theme +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_x_reverse()

Particle_physico_para_SPM_mgperL
```


```{r Basic Particle Area (Unstained) plot}

#Remove free living organism abundance, and stained particles
Particle.df = subset(Brightfield_sum_V1.df, Fraction!="0.2 filtered" & Condition!="TEP" & Condition!="CSP")

#Rename stations for pretty plots
Particle.df$Station = gsub("Station2$", "Muhlenberger Loch", Particle.df$Station)
Particle.df$Station = gsub("Station3$", "Twielenfleth", Particle.df$Station)
Particle.df$Station = gsub("Station4$", "Schwarztonnensand", Particle.df$Station)
Particle.df$Station = gsub("Station5$", "Brunsbuttel", Particle.df$Station)
Particle.df$Station = gsub("Station6$", "Meedem Grund", Particle.df$Station)

Particle.df$Station = factor(Particle.df$Station,
                             levels = c("Meedem Grund", 
                                        "Brunsbuttel",
                                        #"Kollmar",
                                        "Schwarztonnensand",
                                        "Twielenfleth",
                                        "Muhlenberger Loch"#,
                                        #"SeemanshÃ¶ft"
                                        ))

Particle.df$Fraction = gsub("Light", "Suspended", Particle.df$Fraction)
Particle.df$Fraction = gsub("Heavy", "Sinking", Particle.df$Fraction)
Particle.df$Fraction = gsub("0point2", "0.2 filtered", Particle.df$Fraction)
Particle.df$Fraction = factor(Particle.df$Fraction,
                             levels = c("Suspended", "Sinking", "0.2 filtered"))

Particle.df$Condition = gsub("AlcianBlue", "TEP", Particle.df$Condition)
Particle.df$Condition = gsub("CBBG", "CSP", Particle.df$Condition)
Particle.df$Condition = gsub("Particle", "Unstained", Particle.df$Condition)
Particle.df$Condition = gsub("0point2", "Unstained 0.2Âµm filtered", Particle.df$Condition)
Particle.df$Condition = factor(Particle.df$Condition,
                             levels = c("Unstained", "Unstained 0.2Âµm filtered", "TEP", "CSP"))

#Add stromkilometer column
Particle.df$Stromkilometer = Particle.df$Station
Particle.df$Stromkilometer = gsub("Muhlenberger Loch", 633, Particle.df$Stromkilometer)
Particle.df$Stromkilometer = gsub("Twielenfleth", 651, Particle.df$Stromkilometer)
Particle.df$Stromkilometer = gsub("Schwarztonnensand", 665, Particle.df$Stromkilometer)
Particle.df$Stromkilometer = gsub("Brunsbuttel", 694, Particle.df$Stromkilometer)
Particle.df$Stromkilometer = gsub("Meedem Grund", 712, Particle.df$Stromkilometer)
Particle.df = subset(Particle.df, Station!="NEGATIVE" & Station!="BunthausSpitze")
Particle.df$Stromkilometer = as.numeric(as.character(Particle.df$Stromkilometer))

Particle.df$Date = factor(Particle.df$Date,
                             levels = c("2021.05",
                                        "2021.07", 
                                        #"11.2021", 
                                        "2022.02", 
                                        "2022.05", 
                                        "2022.06",
                                        "2022.11"
                                        ))


#Summarise plots for easy plotting
Particle_sum.df = Rmisc::summarySE(Particle.df, 
                            measurevar="CorrAreaL", 
                            groupvars=c("Date", 
                                        "Station",
                                        "Stromkilometer",
                                        "Condition",
                                        "Fraction"),
                            na.rm = T)


#Don't need to correct for neutrally buoyant particles
#i=1
#x=2
#Particle_sum.df$CorrectedValues = 0
#for (i in 1:length(Particle_sum.df$Station)) {
  #for (x in 1:length(Particle_sum.df$Station)) {
  #
   # if (grepl(Particle_sum.df$Date[i],Particle_sum.df$Date[x] ) == T &
    #    grepl(Particle_sum.df$Station[i],Particle_sum.df$Station[x] ) == T &
     #   grepl(Particle_sum.df$Condition[i],Particle_sum.df$Condition[x] ) == T & 
      #  grepl(Particle_sum.df$Fraction[i],Particle_sum.df$Fraction[x] ) == F &
       # grepl(Particle_sum.df$Fraction[i], "Light") == T & 
        #grepl(Particle_sum.df$Fraction[x], "Heavy") == T) {
      
#      tmp = Particle_sum.df$CorrAreaL[x] - Particle_sum.df$CorrAreaL[i]
 #     
  #    Particle_sum.df$CorrectedValues[i] = Particle_sum.df$CorrAreaL[i]
   #   Particle_sum.df$CorrectedValues[x] = tmp
    #  print("Test")
        #}
    #}
#}


#Plot data
Particle_sum.plot = ggplot(Particle_sum.df, aes(y = CorrAreaL, 
                                                x = Stromkilometer, 
                                                colour = Fraction, 
                                                group = Fraction)) +
  geom_line(size = 1)+
  #scale_y_log10()+
  geom_errorbar(aes(ymin=(CorrAreaL-ci), 
                    ymax=(CorrAreaL+ci), 
                    colour = Fraction),
                #position=pd,
                size = 1,
                width = 0.5
                )+
  facet_grid(Date ~ .)+
  scale_color_manual("Particle concentration fraction", values = cbbPalette)+
  theme_bw() +
  My_Theme +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ylab(expression(Particle~concentration~"(Âµm"^2*L^"-1"*")"))+
  scale_x_reverse()

Particle_sum.plot






```


```{r Combined SPM and particle area plot}

####Combine dataframes####
#Make sure names match for the same variables
colnames(Particle_physico_para.df)
colnames(Particle_sum.df)

Particle_sum.df$Sample_date = Particle_sum.df$Date
Particle_sum.df$Date = NULL
Particle_sum.df$Condition = NULL
Particle_sum.df$Sample_date = gsub("2021.07", "Jul-21", Particle_sum.df$Sample_date)
#Particle_sum.df$Sample_date = gsub("2021.11", "Nov-21", Particle_sum.df$Sample_date)
Particle_sum.df$Sample_date = gsub("2022.02", "Feb 22", Particle_sum.df$Sample_date)
Particle_sum.df$Sample_date = gsub("2022.05", "May 22", Particle_sum.df$Sample_date)
Particle_sum.df$Sample_date = gsub("2022.06", "Jun 22", Particle_sum.df$Sample_date)
Particle_sum.df$Sample_date = gsub("2022.11", "Nov 22", Particle_sum.df$Sample_date)

#Merge two dataframes
Merged_Fig.df = merge(Particle_physico_para.df, Particle_sum.df, by = c("Station", "Stromkilometer", "Sample_date", "Fraction"))


#Set order to consistency
Merged_Fig.df$Fraction = factor(Merged_Fig.df$Fraction,
                                              levels = c("Suspended",
                                                         "Sinking"))

####Plot ####
# Value used to transform the data
coeff <- 150000000

#Remove November 2021 Land cruise 
Merged_Fig.df = subset(Merged_Fig.df, Sample_date!="Nov-21" & Sample_date!="Jul-21")

Figure.plot = ggplot(Merged_Fig.df, 
                       aes(x=Stromkilometer, 
                           fill = Fraction, 
                           group = Fraction)) +
  geom_bar(aes(y=as.numeric(SPM_mgperL, 
                            fill=Fraction, 
                            group = Fraction,
                            colour = "black")), 
            stat="identity", 
            position = "dodge") + 
  geom_line(aes(y=CorrAreaL / coeff, 
                 colour = Fraction, 
                 group = Fraction), size=2) +
  geom_errorbar(aes(ymin=((CorrAreaL -se)/ coeff), 
                    ymax=((CorrAreaL+se)/ coeff), 
                    colour = Fraction),
                #position=pd,
                size = 1,
                width = 0.5
                )+
  xlab("Elbe km")+
  scale_y_continuous(
    name = "Particulate dry-weight \n(mg / L)", # Features of the first axis
    sec.axis = sec_axis(~.*coeff, 
                        name=expression(Particle~conc.~"(Âµm"^2*L^"-1"*")"), # Add a second axis and specify its features
                        breaks = c(0.0e+00, 5.0e+10, 1.0e+11)),
    breaks = c(0, 150, 300)) +     
  scale_fill_manual("Dry-weight \nfractions", values = FractionColourList)+
  scale_colour_manual("Particle \nconc. \nfractions", values = FractionSecondaryColourList)+
  guides(fill = guide_legend(order = 1),
         colour = guide_legend(order = 2)
         )+
  facet_grid(Sample_date ~ .)+
  My_Theme+
  #ggtitle("SPM concentration vs unstained particle area")#+
  scale_x_reverse()+
  theme(legend.position = "bottom")

Figure.plot

pdf("/YOUR/PATH/HERE/Dryweight_ParticleConc_perL.pdf", height = 7, width = 9)
Figure.plot
dev.off()
```


```{r Mean calculations}
test_mean = Merged_Fig.df[-13,] %>% 
  dplyr::group_by(Sample_date) %>% 
  dplyr::summarise(#sum_val = sum(Abundance),
                   mean_SPM = mean(as.numeric(SPM_mgperL)), 
                   sd_SPM = sd(as.numeric(SPM_mgperL)),
                   mean_PA = mean(as.numeric(CorrAreaL)), 
                   sd_PA = sd(as.numeric(CorrAreaL)))
print(test_mean)

#Calculate standard deviation vs mean percentage
mean(1 - (test_mean$sd_PA / test_mean$mean_PA))


test_mean = Merged_Fig.df[-13,] %>% 
  dplyr::group_by(Sample_date, Fraction) %>% 
  dplyr::summarise(mean_PA = mean(as.numeric(CorrAreaL)), 
                   sd_PA = sd(as.numeric(CorrAreaL)))
print(test_mean)

test_mean = test_mean %>% 
  dplyr::group_by(Sample_date) %>% 
  dplyr::summarise(FractionCombined = sum(as.numeric(mean_PA)))
print(test_mean)


#Plot mean seasonal particle area
ggplot(test_mean, 
       aes(x=Sample_date,
           y = mean_PA, group = Fraction, colour = Fraction))+
  geom_line(size=2)


#Calculate date * station
test_mean = Merged_Fig.df %>% 
  dplyr::group_by(Sample_date, Stromkilometer) %>% 
  dplyr::summarise(Mean_Dry_val = mean(as.numeric(SPM_mgperL)), Mean_Conc_val = mean(as.numeric(CorrAreaL)))
print(test_mean)


#Plot mean dry-weight
ggplot(test_mean, 
       aes(x=Stromkilometer,
           y = Mean_Dry_val, group = Sample_date, colour = Sample_date))+
  geom_line(size=2)
#Plot mean particle conc.
ggplot(test_mean, 
       aes(x=Stromkilometer,
           y = Mean_Conc_val, group = Sample_date, colour = Sample_date))+
  geom_line(size=2)

#Plot mean seasonal particle area
ggplot(Merged_Fig.df, 
       aes(x= Stromkilometer,
         y = as.numeric(SPM_mgperL), group = Sample_date, colour = Sample_date))+
  #geom_smooth(size=2)+
  geom_line(aes(y = as.numeric(Temperature)*10))
#Temperature seems to have no effect

```


```{r Statistics}

#Add seasonal date to dataframe and reorder
Particle_physico_para.df$Season = Particle_physico_para.df$Sample_date
Particle_physico_para.df$Season = gsub("Jul-21", "Summer", Particle_physico_para.df$Season)
Particle_physico_para.df$Season = gsub("Nov-21", "Autumn", Particle_physico_para.df$Season)
Particle_physico_para.df$Season = gsub("Feb 22", "Winter", Particle_physico_para.df$Season)
Particle_physico_para.df$Season = gsub("May 22", "Spring", Particle_physico_para.df$Season)
Particle_physico_para.df$Season = gsub("Jun 22", "Summer", Particle_physico_para.df$Season)
Particle_physico_para.df$Season = gsub("Nov 22", "Autumn", Particle_physico_para.df$Season)
Particle_sum.df$Season = Particle_sum.df$Sample_date
Particle_sum.df$Season = gsub("Jul-21", "Summer", Particle_sum.df$Season)
Particle_sum.df$Season = gsub("Nov-21", "Autumn", Particle_sum.df$Season)
Particle_sum.df$Season = gsub("Feb 22", "Winter", Particle_sum.df$Season)
Particle_sum.df$Season = gsub("May 22", "Spring", Particle_sum.df$Season)
Particle_sum.df$Season = gsub("Jun 22", "Summer", Particle_sum.df$Season)
Particle_sum.df$Season = gsub("Nov 22", "Autumn", Particle_sum.df$Season)


#Significant differences over stations - SPM
SPM_mgperL_model = aov(SPM_mgperL ~ Station, data = Particle_physico_para.df)
summary(SPM_mgperL_model)
rstatix::eta_squared(SPM_mgperL_model)

#create a new variable for Elbekm2
Particle_physico_para.df$Stromkilometer2 = as.numeric(Particle_physico_para.df$Stromkilometer)^2
Particle_physico_para.df$Stromkilometer = as.numeric(Particle_physico_para.df$Stromkilometer)

#fit quadratic regression model
quadraticModel <- lm(SPM_mgperL ~ Stromkilometer + Stromkilometer2, data=Particle_physico_para.df)
#view model summary
summary(quadraticModel)

#Significant differences over seasons - SPM
SPM_mgperL_model = aov(SPM_mgperL ~ Season, data = Particle_physico_para.df)
summary(SPM_mgperL_model)
rstatix::eta_squared(SPM_mgperL_model)

#Significant differences over dates - SPM
SPM_mgperL_model = aov(SPM_mgperL ~ Sample_date, data = Particle_physico_para.df)
summary(SPM_mgperL_model)
rstatix::eta_squared(SPM_mgperL_model)

#Significant differences over fractions - SPM
SPM_mgperL_model = aov(SPM_mgperL ~ Fraction, data = Particle_physico_para.df)
summary(SPM_mgperL_model)
rstatix::eta_squared(SPM_mgperL_model)
  
  Particle_physico_para.df$SPM_mgperL = as.numeric(as.character(Particle_physico_para.df$SPM_mgperL))
  Mean_SPM = Particle_physico_para.df %>%
  group_by(Fraction) %>%
  dplyr::summarise(mean_val = mean(SPM_mgperL), sd = sd(SPM_mgperL), median = median(SPM_mgperL), max = max(SPM_mgperL))
  print(Mean_SPM)

#Significant difference with station and fraction interaction - SPM
SPM_mgperL_model = aov(SPM_mgperL ~ Fraction * Station, data = Particle_physico_para.df)
summary(SPM_mgperL_model)
rstatix::eta_squared(SPM_mgperL_model)

#Significant difference with season and station interaction - SPM
SPM_mgperL_model = aov(SPM_mgperL ~ Season * Station, data = Particle_physico_para.df)
summary(SPM_mgperL_model)
rstatix::eta_squared(SPM_mgperL_model)

#Significant difference with date and station interaction - SPM
SPM_mgperL_model = aov(SPM_mgperL ~ Sample_date * Station, data = Particle_physico_para.df)
summary(SPM_mgperL_model)
rstatix::eta_squared(SPM_mgperL_model)

  Particle_physico_para.df$SPM_mgperL = as.numeric(as.character(Particle_physico_para.df$SPM_mgperL))
  Mean_SPM = Particle_physico_para.df %>%
  group_by(Sample_date, Station) %>%
  dplyr::summarise(mean_val = mean(SPM_mgperL), sd = sd(SPM_mgperL), median = median(SPM_mgperL), max = max(SPM_mgperL))
  print(Mean_SPM)

#Significant difference with season and fraction interaction - SPM
SPM_mgperL_model = aov(SPM_mgperL ~ Season * Fraction, data = Particle_physico_para.df)
summary(SPM_mgperL_model)
rstatix::eta_squared(SPM_mgperL_model)

#Significant difference with Date and fraction interaction - SPM
SPM_mgperL_model = aov(SPM_mgperL ~ Sample_date * Fraction, data = Particle_physico_para.df)
summary(SPM_mgperL_model)
rstatix::eta_squared(SPM_mgperL_model)

#Significant difference with Season, Station, and Fraction interaction - SPM
SPM_mgperL_model = aov(SPM_mgperL ~ Season * Station * Fraction, data = Particle_physico_para.df)
summary(SPM_mgperL_model)
rstatix::eta_squared(SPM_mgperL_model)

#Significant difference with Date, Station, and Fraction interaction - SPM
SPM_mgperL_model = aov(SPM_mgperL ~ Sample_date * Station * Fraction, data = Particle_physico_para.df)
summary(SPM_mgperL_model)
rstatix::eta_squared(SPM_mgperL_model)






#Significant differences over stations - UnstainedParticleArea
CorrAreaL_model = aov(CorrAreaL ~ Station, data = Particle_sum.df)
summary(CorrAreaL_model)
rstatix::eta_squared(CorrAreaL_model)

#create a new variable for Elbekm2
#Replace station names with Elbe km
Particle_sum.df$Elbe_km = Particle_sum.df$Station
Particle_sum.df$Elbe_km = gsub("Muhlenberger Loch", 633, Particle_sum.df$Elbe_km)
Particle_sum.df$Elbe_km = gsub("Twielenfleth", 651, Particle_sum.df$Elbe_km)
Particle_sum.df$Elbe_km = gsub("Schwarztonnensand", 665, Particle_sum.df$Elbe_km)
Particle_sum.df$Elbe_km = gsub("Brunsbuttel", 694, Particle_sum.df$Elbe_km)
Particle_sum.df$Elbe_km = gsub("Meedem Grund", 712, Particle_sum.df$Elbe_km)
Particle_physico_para.df$Elbe_km = as.numeric(Particle_physico_para.df$Elbe_km)
Particle_sum.df$Elbe_km2 = as.numeric(Particle_sum.df$Elbe_km)^2
#fit quadratic regression model
quadraticModel <- lm(CorrAreaL ~ Elbe_km + Elbe_km2, data=Particle_sum.df)
#view model summary
summary(quadraticModel)


#Significant differences over seasons - UnstainedParticleArea
CorrAreaL_model = aov(CorrAreaL ~ Season, data = Particle_sum.df)
summary(CorrAreaL_model)
rstatix::eta_squared(CorrAreaL_model)

#Significant differences over dates - UnstainedParticleArea
CorrAreaL_model = aov(CorrAreaL ~ Sample_date, data = Particle_sum.df)
summary(CorrAreaL_model)
rstatix::eta_squared(CorrAreaL_model)
  Particle_sum.df$CorrAreaL = as.numeric(as.character(Particle_sum.df$CorrAreaL))
  Mean_CorrAreaL = Particle_sum.df %>%
  group_by(Sample_date) %>%
  dplyr::summarise(mean_val = mean(CorrAreaL), sd = sd(CorrAreaL), median = median(CorrAreaL), max = max(CorrAreaL))
  print(Mean_CorrAreaL)

#Significant differences over Fraction - UnstainedParticleArea
CorrAreaL_model = aov(CorrAreaL ~ Fraction, data = Particle_sum.df)
summary(CorrAreaL_model)
rstatix::eta_squared(CorrAreaL_model)
  Particle_sum.df$CorrAreaL = as.numeric(as.character(Particle_sum.df$CorrAreaL))
  Mean_CorrAreaL = Particle_sum.df %>%
  group_by(Fraction) %>%
  dplyr::summarise(mean_val = mean(CorrAreaL), sd = sd(CorrAreaL), median = median(CorrAreaL), max = max(CorrAreaL))
  print(Mean_CorrAreaL)
  
#Significant difference with station and fraction interaction - UnstainedParticleArea
CorrAreaL_model = aov(CorrAreaL ~ Fraction * Station, data = Particle_sum.df)
summary(CorrAreaL_model)
rstatix::eta_squared(CorrAreaL_model)

#Significant difference with season and station interaction - UnstainedParticleArea
CorrAreaL_model = aov(CorrAreaL ~ Season * Station, data = Particle_sum.df)
summary(CorrAreaL_model)
rstatix::eta_squared(CorrAreaL_model)

#Significant difference with date and station interaction - UnstainedParticleArea
CorrAreaL_model = aov(CorrAreaL ~ Sample_date * Station, data = Particle_sum.df)
summary(CorrAreaL_model)
rstatix::eta_squared(CorrAreaL_model)

#Significant difference with season and fraction interaction - UnstainedParticleArea
CorrAreaL_model = aov(CorrAreaL ~ Season * Fraction, data = Particle_sum.df)
summary(CorrAreaL_model)
rstatix::eta_squared(CorrAreaL_model)

#Significant difference with Date and fraction interaction - UnstainedParticleArea
CorrAreaL_model = aov(CorrAreaL ~ Sample_date * Fraction, data = Particle_sum.df)
summary(CorrAreaL_model)
rstatix::eta_squared(CorrAreaL_model)

#Significant difference with Season, Station, and Fraction interaction - UnstainedParticleArea
CorrAreaL_model = aov(CorrAreaL ~ Season * Station * Fraction, data = Particle_sum.df)
summary(CorrAreaL_model)
rstatix::eta_squared(CorrAreaL_model)

#Significant difference with Date, Station, and Fraction interaction - UnstainedParticleArea
CorrAreaL_model = aov(CorrAreaL ~ Sample_date * Station * Fraction, data = Particle_sum.df)
summary(CorrAreaL_model)
rstatix::eta_squared(CorrAreaL_model)






#Correlation between Particle area/L and SPM mg/L
cor.test(as.numeric(Merged_Fig.df$SPM_mgperL), Merged_Fig.df$CorrAreaL, method = "spearman")

Merged_Fig_Sus.df = subset(Merged_Fig.df, Fraction == "Suspended")
cor.test(as.numeric(Merged_Fig_Sus.df$SPM_mgperL), Merged_Fig_Sus.df$CorrAreaL, method = "spearman")
Merged_Fig_Sink.df = subset(Merged_Fig.df, Fraction == "Sinking")
cor.test(as.numeric(Merged_Fig_Sink.df$SPM_mgperL), Merged_Fig_Sink.df$CorrAreaL, method = "spearman")


#Area to salinity?

#Significant dry weight over salinity - SPM
cor.test(as.numeric(Merged_Fig.df$SPM_mgperL), as.numeric(Merged_Fig.df$Salinity), method = "s")
#Significant particle concentration over salinity - Particle conc.
cor.test(as.numeric(Merged_Fig.df$CorrAreaL), as.numeric(Merged_Fig.df$Salinity), method = "s")

#To temperature?
#Significant dry weight over salinity - SPM
cor.test(as.numeric(Merged_Fig.df$SPM_mgperL), as.numeric(Merged_Fig.df$Temperature), method = "s")
#Significant particle concentration over salinity - Particle conc.
cor.test(as.numeric(Merged_Fig.df$CorrAreaL), as.numeric(Merged_Fig.df$Temperature), method = "s")



#Mean SPM per season
Particle_physico_para.df$SPM_mgperL = as.numeric(Particle_physico_para.df$SPM_mgperL)
Mean_SPM = Particle_physico_para.df %>%
  group_by(Season, Fraction) %>%
  dplyr::summarise(mean_val = mean(SPM_mgperL), sd = sd(SPM_mgperL), median = median(SPM_mgperL), max = max(SPM_mgperL))
print(Mean_SPM)
Mean_SPM$Season = factor(Mean_SPM$Season,
                         levels = c("Spring",
                                    "Summer",
                                    "Autumn",
                                    "Winter"))

Mean_SPM_mgperL.plt = ggplot(subset(Mean_SPM, Season!="May-21"), 
                            aes(x = Season,
                                y = as.numeric(mean_val),
                                colour = Fraction,
                                group = Fraction
                                )) + 
  geom_line(size = 1)+
  stat_summary(fun = sum, na.rm = TRUE, group = 3, color = 'grey', geom ='line', size = 1)+
  theme_bw()+
  ylab("Suspended Particulate Matter \n(mg / L)")+
  xlab("Season")+
  scale_color_manual("Particle Fraction", values = cbbPalette)+
  My_Theme +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

Mean_SPM_mgperL.plt



#Mean Area per season

Particle_sum.df = na.omit(Particle_sum.df)

Mean_Area = Particle_sum.df %>%
  group_by(Season, Fraction) %>%
  dplyr::summarise(mean_val = mean(CorrAreaL), sd = sd(CorrAreaL), median = median(CorrAreaL), max = max(CorrAreaL))
print(Mean_Area)
Mean_Area$Season = factor(Mean_Area$Season,
                                              levels = c("Spring",
                                                         "Summer",
                                                         "Autumn",
                                                         "Winter"))
Mean_Area.plt = ggplot(Mean_Area, 
                            aes(x = Season,
                                y = as.numeric(mean_val),
                                colour = Fraction,
                                group = Fraction
                                )) + 
  geom_line(size = 1)+
  stat_summary(fun = sum, na.rm = TRUE, group = 3, color = 'grey', geom ='line', size = 1)+
  theme_bw()+
  ylab("Suspended Particulate Matter \n(mg / L)")+
  xlab("Season")+
  scale_color_manual("Particle Fraction", values = cbbPalette)+
  My_Theme +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

Mean_Area.plt


```


##Part B - Visible Particle Density differences
Need to calculate % of weight attributed to visible particles - calculate from % of particle area from TEP/CSP/Visible combination?

No - is too inaccurate and makes too many assumptions
#Figure 5 - Carbon contributions and calculations 
###CHN analysis component
```{r}

unique(CHN.Elbe$Date)

CHN.Elbe = CHN.Elbe_v0

CHN.Elbe$Date = gsub("May.2021", "2021.05", CHN.Elbe$Date)
CHN.Elbe$Date = gsub("Jul.2021", "2021.07", CHN.Elbe$Date)
CHN.Elbe$Date = gsub("Feb.2022", "2022.02", CHN.Elbe$Date)
CHN.Elbe$Date = gsub("May.2022", "2022.05", CHN.Elbe$Date)
CHN.Elbe$Date = gsub("Jun.2022", "2022.06", CHN.Elbe$Date)
CHN.Elbe$Date = gsub("Nov.2022", "2022.11", CHN.Elbe$Date)

CHN.Elbe$Date = factor(CHN.Elbe$Date,
                                levels = c("2021.05",
                                           "2021.07",
                                           "2022.02",
                                           "2022.05",
                                           "2022.06",
                                           "2022.11"))

CHN.Elbe$Station = factor(CHN.Elbe$Station,
                                levels = c("Meedem Grund",
                                           "Brunsbuttel",
                                           "Schwarztonnensand",
                                           "Twielenfleth",
                                           "Muhlenberger Loch"))

CHN.Elbe$Fraction = gsub("Light", "Suspended Particles", CHN.Elbe$Fraction)
CHN.Elbe$Fraction = gsub("Heavy", "Sinking Particles", CHN.Elbe$Fraction)

CHN.Elbe$Fraction = factor(CHN.Elbe$Fraction,
                                levels = c("Suspended Particles",
                                           "Sinking Particles"))

CHN.Elbe.sum = Rmisc::summarySE(CHN.Elbe, 
                                measurevar = "C_mgperL",
                                groupvars = c("Station",
                                              "Fraction",
                                              "Date",
                                              "Organic"))

CHN.Elbe.sum$Groups = paste0(CHN.Elbe.sum$Fraction, CHN.Elbe.sum$Organic)

C_mgperL.plt = ggplot(CHN.Elbe.sum, aes(x = Station, y = C_mgperL, colour = Organic, group = Groups))+
  geom_line(aes(linetype = Fraction), size = 1)+
  geom_point(aes(shape = Fraction), size = 5)+
  facet_grid(Date ~ .)+
  My_Theme+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


C_mgperL.plt


N_mgperL.plt = ggplot(subset(CHN.Elbe, Organic=="Total"), aes(x = Station, y = N_mgperL, group = Organic), fill = "black")+
  geom_bar(stat= "identity", position = "dodge")+
  facet_grid(Date ~ Fraction)+
  My_Theme+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


N_mgperL.plt

ggarrange(C_mgperL.plt, N_mgperL.plt)

```
###DOC component
```{r}

Physico_para.df = read.csv("/YOUR/PATH/HERE/Data/PhysicochemicalParameters_mod.txt", encoding = "UTF-8", sep = "\t")
Dissolved_physico_para.df = unique(Physico_para.df[,c(4,7,8,16,18)])

Dissolved_physico_para.df = subset(Dissolved_physico_para.df, Sample_type == "Free_living" & Sample_date!="Nov-21" & Station!="BunthausSpitze")

Dissolved_physico.lng.df <- gather(Dissolved_physico_para.df, Organic, C_mgperL, DOC_mg.L:DIC_mg.L, factor_key=TRUE)
Dissolved_physico.lng.df

Dissolved_physico.lng.df =  Dissolved_physico.lng.df[!(is.na(Dissolved_physico.lng.df$C_mgperL) | Dissolved_physico.lng.df$C_mgperL==""), ] # Remove blank values

Dissolved_physico.lng.df$C_mgperL

Dissolved_physico.lng.df$C_mgperL = as.numeric(as.character(Dissolved_physico.lng.df$C_mgperL))

Dissolved_physico.lng.df$Date = Dissolved_physico.lng.df$Sample_date
Dissolved_physico.lng.df$Sample_date = NULL

DOC.Elbe.sum = Rmisc::summarySE(Dissolved_physico.lng.df, 
                                measurevar = "C_mgperL",
                                groupvars = c("Station",
                                              "Organic",
                                              "Date",
                                              "Organic"))

DOC.Elbe.sum$Date = gsub("May 21", "2021.05", DOC.Elbe.sum$Date)
DOC.Elbe.sum$Date = gsub("Jul 21", "2021.07", DOC.Elbe.sum$Date)
DOC.Elbe.sum$Date = gsub("Feb 22", "2022.02", DOC.Elbe.sum$Date)
DOC.Elbe.sum$Date = gsub("May 22", "2022.05", DOC.Elbe.sum$Date)
DOC.Elbe.sum$Date = gsub("Jun 22", "2022.06", DOC.Elbe.sum$Date)
DOC.Elbe.sum$Date = gsub("Nov 22", "2022.11", DOC.Elbe.sum$Date)
DOC.Elbe.sum$Date = factor(DOC.Elbe.sum$Date,
                                levels = c("2021.05",
                                           "2021.07",
                                           "2022.02",
                                           "2022.05",
                                           "2022.06",
                                           "2022.11"))

DOC.Elbe.sum$Station = factor(DOC.Elbe.sum$Station,
                                levels = c("Meedem Grund",
                                           "Brunsbuttel",
                                           "Schwarztonnensand",
                                           "Twielenfleth",
                                           "Muhlenberger Loch"))

DOC.Elbe.sum$Fraction = "Dissolved"
DOC.Elbe.sum$Organic = gsub("DOC", "Organic Carbon", DOC.Elbe.sum$Organic)
DOC.Elbe.sum$Organic = gsub("DIC", "Inorganic Carbon", DOC.Elbe.sum$Organic)
DOC.Elbe.sum$Groups = paste0(DOC.Elbe.sum$Fraction, DOC.Elbe.sum$Organic)

DC_mgperL.plt = ggplot(DOC.Elbe.sum, aes(x = Station, y = C_mgperL, colour = Organic, group = Groups))+
  geom_line(aes(linetype = Fraction), size = 1)+
  geom_point(aes(shape = Fraction), size = 5)+
  facet_grid(Date ~ .)+
  My_Theme+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
DC_mgperL.plt


stats.sum = DOC.Elbe.sum %>%
  group_by(Organic) %>%
  summarise(mean_stat = mean(C_mgperL))
stats.sum

stats.sum = DOC.Elbe.sum %>%
  group_by(Date) %>%
  summarise(mean_stat = mean(C_mgperL))
stats.sum

stats.sum = DOC.Elbe.sum %>%
  group_by(Date, Organic) %>%
  summarise(mean_stat = mean(C_mgperL))
stats.sum

```


###Free-living biomass
```{r}
####Format and make pretty####
#Import dataframes
SYBR_sum.df = read.csv("YOU/PATH/HERE/Data/AllSYBR_Summary.csv")
#SYBR_sum.df[is.na(SYBR_sum.df)] <- 0
dim(SYBR_sum.df)
SYBR_sum.df = na.omit(SYBR_sum.df)
dim(SYBR_sum.df)
#Remove unneeded data
SYBR_FL.df = subset(SYBR_sum.df, Condition=="0point2")
SYBR_PAO.df = subset(SYBR_sum.df, Condition=="Particle")



#Calculate mean FLO and PAO
SYBR_FL.sum = Rmisc::summarySE(SYBR_FL.df, 
                               measurevar = "Count",
                               groupvars = c("Station",
                                             "Date"))
SYBR_FL_Ave.sum = Rmisc::summarySE(SYBR_FL.df, 
                               measurevar = "Average_Size",
                               groupvars = c("Station",
                                             "Date"))
SYBR_FL.sum$Average_Size = SYBR_FL_Ave.sum$Average_Size

SYBR_PAO.sum = Rmisc::summarySE(SYBR_PAO.df, 
                               measurevar = "Count",
                               groupvars = c("Station",
                                             "Date"))


#Subtract PAO from 0.2Âµm filter for corrected free-living abundance
SYBR_FL.sum$Corr_FL = 0
for (i in 1:length(SYBR_FL.sum$Station)) {
  
  #Make sure variables match
  DateID=SYBR_FL.sum$Date[i]
  StationID=SYBR_FL.sum$Station[i]
  #StainID=SYBR_FL.sum$Condition[i]
  #FractionID=SYBR_FL.sum$Fraction[i]
  
  #Print IDs for bug checking
  print(paste0(DateID, " ", StationID))
  
  #Subset particle information based on IDs
  SYBR_PAO.tmp = subset(SYBR_PAO.sum, 
                           Date==DateID &
                             Station==StationID# &
                             #Condition==ConditionID & 
                             #Fraction==FractionID &
                             #ImageNumber==ImageID
                     )$Count
  
  
  #Subtract PAO from Total 
  SYBR_FL.sum$Corr_FL[i] = SYBR_FL.sum$Count[i] - SYBR_PAO.tmp
  
}

#Check to make sure it's worked well
SYBR_FL.sum

#Particle count per L = particle count in image * magnification effect (x630) with field of view * convert from 1 mL sample to L
SYBR_FL.sum$Corr_FL = SYBR_FL.sum$Corr_FL * 10122.6872775 * 1000

#Rename stations for pretty plots
SYBR_FL.sum$Station = gsub("Station2$", "Muhlenberger Loch", SYBR_FL.sum$Station)
SYBR_FL.sum$Station = gsub("Station3$", "Twielenfleth", SYBR_FL.sum$Station)
SYBR_FL.sum$Station = gsub("Station4$", "Schwarztonnensand", SYBR_FL.sum$Station)
SYBR_FL.sum$Station = gsub("Station5$", "Brunsbuttel", SYBR_FL.sum$Station)
SYBR_FL.sum$Station = gsub("Station6$", "Meedem Grund", SYBR_FL.sum$Station)


SYBR_FL.sum$Station = factor(SYBR_FL.sum$Station,
                             levels = c("Meedem Grund", 
                                        "Brunsbuttel",
                                        "Schwarztonnensand",
                                        "Twielenfleth",
                                        "Muhlenberger Loch"))



#Convert ES area to ES volume 
SYBR_FL.sum$radius = sqrt(SYBR_FL.sum$Average_Size / pi)
SYBR_FL.sum$Mean_Volume = 4/3 * pi * (SYBR_FL.sum$radius^3)

#Use allometric measurement to calculate cellular carbon
SYBR_FL.sum$FL_Carbon_fg = (162 * SYBR_FL.sum$Mean_Volume^0.91) * SYBR_FL.sum$Corr_FL
SYBR_FL.sum$FL_Carbon_ug = SYBR_FL.sum$FL_Carbon_fg / 10^9

SYBR_FL.sum$Date = as.character(SYBR_FL.sum$Date)

#Plot data
SYBR_FL_sum_CCR.plot = ggplot(SYBR_FL.sum, aes(y = FL_Carbon_ug, x = Station, colour = Date, group = Date)) +
  geom_line(size = 1)+
  #scale_y_log10()+
  geom_errorbar(aes(ymin=(FL_Carbon_ug-ci), 
                    ymax=(FL_Carbon_ug+ci), 
                    colour = Date),
                #position=pd,
                size = 1,
                width = 0.5
                )+
  #facet_grid(Condition ~ Date)+
  #scale_color_manual("Sampling time", values = cbbPalette)+
  theme_bw() +
  My_Theme +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  #ylab("")
  ylab(expression(atop("Free-living"~organism~Carbon,
                  "(Âµg"~L^"-1"*")")))+
  #guides(colour = "none")+
  ggtitle("Allometric Carbon Calculation")

SYBR_FL_sum_CCR.plot
FL_C_sum = SYBR_FL.sum %>%
  group_by(Date) %>%
  dplyr::summarise(median_val = median(FL_Carbon_ug), 
                   mean_val = mean(as.numeric(FL_Carbon_ug)), 
                   sd = sd(as.numeric(FL_Carbon_ug)))
FL_C_sum
```

###PAO biomass
```{r}
#Import dataframe
PAO.df = read.csv("YOU/PATH/HERE/Data/AllColonisation_Summary.csv")

#Particle count per L = particle count in image * magnification effect (x630) with field of view * convert from 1 mL sample to L
PAO.df$Count = PAO.df$Count * 10122.6872775 * 1000


#Rename sttaions for pretty plots
PAO.df$Station = gsub("Station2$", "Muhlenberger Loch", PAO.df$Station)
PAO.df$Station = gsub("Station3$", "Twielenfleth", PAO.df$Station)
PAO.df$Station = gsub("Station4$", "Schwarztonnensand", PAO.df$Station)
PAO.df$Station = gsub("Station5$", "Brunsbuttel", PAO.df$Station)
PAO.df$Station = gsub("Station6$", "Meedem Grund", PAO.df$Station)

PAO.df$Station = factor(PAO.df$Station,
                             levels = c("Meedem Grund", 
                                        "Brunsbuttel",
                                        "Schwarztonnensand",
                                        "Twielenfleth",
                                        "Muhlenberger Loch"))

PAO.df$Fraction = gsub("Light", "Suspended", PAO.df$Fraction)
PAO.df$Fraction = gsub("Heavy", "Sinking", PAO.df$Fraction)
PAO.df$Fraction = gsub("0point2", "0.2 filtered", PAO.df$Fraction)
PAO.df$Fraction = factor(PAO.df$Fraction,
                             levels = c("Suspended", "Sinking", "0.2 filtered"))

PAO.df$Condition = gsub("AlcianBlue", "TEP", PAO.df$Condition)
PAO.df$Condition = gsub("CBBG", "CSP", PAO.df$Condition)
PAO.df$Condition = gsub("Particle", "Unstained", PAO.df$Condition)
PAO.df$Condition = gsub("0point2", "Unstained 0.2Âµm filtered", PAO.df$Condition)
PAO.df$Condition = factor(PAO.df$Condition,
                             levels = c("Unstained", "Unstained 0.2Âµm filtered", "TEP", "CSP"))



#Subset to remove particle information, and instead only PAO
PAO.df = subset(PAO.df, Type=="Organism")

#Convert ES area to ES volume 
PAO.df$radius = sqrt(PAO.df$Average_Size / pi)
PAO.df$Mean_Volume = 4/3 * pi * (PAO.df$radius^3)

#Use allometric measurement to calculate cellular carbon
PAO.df$PAO_Carbon_fg = (162 * PAO.df$Mean_Volume^0.91) * PAO.df$Count
PAO.df$PAO_Carbon_ug = PAO.df$PAO_Carbon_fg / 10^9


#Summarise plots for easy plotting
PAO_sum_ACC.df = Rmisc::summarySE(PAO.df, 
                            measurevar="PAO_Carbon_ug", 
                            groupvars=c("Date",
                                        "Station", 
                                        "Condition",
                                        "Fraction"),
                            na.rm = T)

PAO_sum_ACC.df = subset(PAO_sum_ACC.df, Condition!="Unstained 0.2Âµm filtered")


#Plot data
PAO_sum_ACC.plot = ggplot(PAO_sum_ACC.df, aes(y = PAO_Carbon_ug, x = Station, colour = Fraction, group = Fraction)) +
  geom_line(size = 1)+
  #scale_y_log10()+
  geom_errorbar(aes(ymin=(PAO_Carbon_ug-ci), 
                    ymax=(PAO_Carbon_ug+ci), 
                    colour = Fraction),
                #position=pd,
                size = 1,
                width = 0.5
                )+
  facet_grid(Condition ~ Date)+
  scale_color_manual("Particle fraction", values = cbbPalette)+
  theme_bw() +
  My_Theme +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ylab(expression(atop("Particle"~associated~organism,
                  Carbon~"(Âµg"~L^"-1"*")")))+
  ggtitle("Constant Carbon Ratio")
  
PAO_sum_ACC.plot



```





###Combined - for Particulate and Dissolved Carbon

```{r}

####Set up for plot making####
#Make sure names match for the same variables
colnames(CHN.Elbe.sum)
colnames(DOC.Elbe.sum)

#Match naming scheme
DOC.Elbe.sum$Organic = gsub(" Carbon_mg.L", "", DOC.Elbe.sum$Organic)

####Add total to dissolved carbon measurements####
DOC.Elbe.tmp = DOC.Elbe.sum
DOC.Elbe.tmp$Groups = NULL
DOC.Elbe.tmp$N = NULL
DOC.Elbe.tmp$sd = NULL
DOC.Elbe.tmp$se = NULL
DOC.Elbe.tmp$ci = NULL
#DOC.Elbe.tmp$Groups = NULL
DOC.Elbe.tmp


DOC.Elbe.wide = spread(DOC.Elbe.tmp, key = Organic, value = C_mgperL)
DOC.Elbe.wide

DOC.Elbe.wide$Total = DOC.Elbe.wide$Organic + DOC.Elbe.wide$Inorganic

DOC.Elbe.long = gather(DOC.Elbe.wide, Organic, C_mgperL, Inorganic:Total, factor_key=TRUE)
DOC.Elbe.long

DOC.Elbe.long.IO = merge(subset(DOC.Elbe.long, Organic!="Total"), DOC.Elbe.sum, by = c("Station", "Date", "Fraction", "Organic", "C_mgperL"))

colnames(DOC.Elbe.long)
colnames(DOC.Elbe.long.IO)
DOC.Elbe.long$N = 1
DOC.Elbe.long$sd = NA
DOC.Elbe.long$se = NA
DOC.Elbe.long$ci = NA
DOC.Elbe.long$Groups = paste0(DOC.Elbe.long$Fraction, DOC.Elbe.long$Organic)

DOC.Elbe.sum = rbind(subset(DOC.Elbe.long, Organic=="Total"), DOC.Elbe.long.IO)


####Add inorganic to particulate carbon measurements####
CHN.Elbe.tmp = CHN.Elbe.sum
CHN.Elbe.tmp$Groups = NULL
CHN.Elbe.tmp$N = NULL
CHN.Elbe.tmp$sd = NULL
CHN.Elbe.tmp$se = NULL
CHN.Elbe.tmp$ci = NULL
#CHN.Elbe.tmp$Groups = NULL
CHN.Elbe.tmp


CHN.Elbe.wide = spread(CHN.Elbe.tmp, key = Organic, value = C_mgperL)
CHN.Elbe.wide

CHN.Elbe.wide$Inorganic = CHN.Elbe.wide$Total - CHN.Elbe.wide$Organic

CHN.Elbe.long <- gather(CHN.Elbe.wide, Organic, C_mgperL, Organic:Inorganic, factor_key=TRUE)
CHN.Elbe.long

CHN.Elbe.long.IO = merge(subset(CHN.Elbe.long, Organic!="Inorganic"), CHN.Elbe.sum, by = c("Station", "Date", "Fraction", "Organic", "C_mgperL"))

colnames(CHN.Elbe.long)
colnames(CHN.Elbe.long.IO)
CHN.Elbe.long$N = 1
CHN.Elbe.long$sd = NA
CHN.Elbe.long$se = NA
CHN.Elbe.long$ci = NA
CHN.Elbe.long$Groups = paste0(CHN.Elbe.long$Fraction, CHN.Elbe.long$Organic)

CHN.Elbe.sum = rbind(subset(CHN.Elbe.long, Organic=="Inorganic"), CHN.Elbe.long.IO)





####Make plot####

#Make sure names match for the same variables
colnames(CHN.Elbe.sum)
colnames(DOC.Elbe.sum)
         
#Actual merge
C_Elbe.sum = rbind(CHN.Elbe.sum, DOC.Elbe.sum)


C_Elbe.sum$Fraction = factor(C_Elbe.sum$Fraction,
                                levels = c("Dissolved",
                                           "Suspended Particles",
                                           "Sinking Particles"))

C_Elbe.sum$Organic = factor(C_Elbe.sum$Organic,
                                levels = c("Total",
                                           "Organic",
                                           "Inorganic"))


####Simplified####

C_Elbe_simple.df = subset(C_Elbe.sum, Organic!="Total")

C_Elbe_simple.df$Fraction = gsub("Sinking ", "", C_Elbe_simple.df$Fraction)
C_Elbe_simple.df$Fraction = gsub("Suspended ", "", C_Elbe_simple.df$Fraction)

C_Elbe_simple.sum = Rmisc::summarySE(C_Elbe_simple.df, measurevar = "C_mgperL", groupvars = c("Station",
                                                                                   "Fraction",
                                                                                   "Date",
                                                                                   "Organic"),
                                 na.rm = T )

C_Elbe_simple.sum

unique(C_Elbe_simple.sum$Date)

#Change date to fit other figures
C_Elbe_simple.sum$Date = gsub("2021.05", "May-21", C_Elbe_simple.sum$Date)
C_Elbe_simple.sum$Date = gsub("2021.07", "Jul-21", C_Elbe_simple.sum$Date)
C_Elbe_simple.sum$Date = gsub("2022.02", "Feb 22", C_Elbe_simple.sum$Date)
C_Elbe_simple.sum$Date = gsub("2022.05", "May 22", C_Elbe_simple.sum$Date)
C_Elbe_simple.sum$Date = gsub("2022.06", "Jun 22", C_Elbe_simple.sum$Date)
C_Elbe_simple.sum$Date = gsub("2022.11", "Nov 22", C_Elbe_simple.sum$Date)
C_Elbe_simple.sum$Date = factor(C_Elbe_simple.sum$Date,
                                levels = c("May-21",
                                           "Jul-21",
                                           "Feb 22",
                                           "May 22",
                                           "Jun 22",
                                           "Nov 22"
                                           ))

C_Elbe_simple.sum$Groups = paste0(C_Elbe_simple.sum$Fraction, C_Elbe_simple.sum$Organic)


C_Elbe_simple.sum$Stromkilometer = C_Elbe_simple.sum$Station
#Get distance from Hamburg/Elbe distance for spearman tests
C_Elbe_simple.sum$Stromkilometer = gsub("Muhlenberger Loch", 633, C_Elbe_simple.sum$Stromkilometer)
C_Elbe_simple.sum$Stromkilometer = gsub("Twielenfleth", 651, C_Elbe_simple.sum$Stromkilometer)
C_Elbe_simple.sum$Stromkilometer = gsub("Schwarztonnensand", 665, C_Elbe_simple.sum$Stromkilometer)
C_Elbe_simple.sum$Stromkilometer = gsub("Brunsbuttel", 694, C_Elbe_simple.sum$Stromkilometer)
C_Elbe_simple.sum$Stromkilometer = gsub("Meedem Grund", 712, C_Elbe_simple.sum$Stromkilometer)
C_Elbe_simple.sum = subset(C_Elbe_simple.sum, Station!="NEGATIVE" & Station!="BunthausSpitze")


C_Elbe_simple.sum = subset(C_Elbe_simple.sum, Organic == "Organic")

TC_mgperL.plt = ggplot(subset(C_Elbe_simple.sum, Date!="May 21" & Date!="Jul 21"), aes(x = as.numeric(Stromkilometer), y = C_mgperL, group = Groups, shape = Fraction, colour = Fraction))+
  geom_line(size = 1)+
  geom_point(size = 5)+
  facet_grid(Date ~ .)+
  scale_y_continuous(breaks = c(0,10,20))+
  scale_x_reverse()+
  scale_color_manual("Carbon type", values = c("black", "grey50", "navy", "forestgreen"))+
  scale_linetype_manual(values = c("solid", "dashed"))+
  xlab("Elbe km")+
  ylab("Carbon (mg/L)")+
  guides(linetype = guide_legend(order = 1),
         colour = guide_legend(order = 2)
         )+
  Poster_Theme+
  theme(legend.position = "bottom")
TC_mgperL.plt

tiff("Figure5_CarbonContribution.tiff", height = 7, width = 9, units = "in", res = 120)
last_plot()
dev.off()

#png("Figure5_CarbonContribution.png", height = 7, width = 9, units = "in", res = 120)
#last_plot()
#dev.off()

pdf("Figure5_CarbonContribution.pdf", height = 7, width = 9)
last_plot()
dev.off()

```

####Statistics and numbers
```{r}
test = subset(C_Elbe_simple.sum) %>%
  group_by(Date, Organic) %>%
  dplyr::summarise(#median_val = median(SPM_mgperL), 
                   mean_val = mean(as.numeric(C_mgperL)), 
                   sd = sd(as.numeric(C_mgperL)))

print(test)

test = subset(C_Elbe_simple.sum, Fraction =="Particles") %>%
  group_by(Date, Organic) %>%
  dplyr::summarise(#median_val = median(SPM_mgperL), 
                   mean_val = mean(as.numeric(C_mgperL)), 
                   sd = sd(as.numeric(C_mgperL)))

print(test)

test = subset(C_Elbe_simple.sum, Fraction =="Dissolved") %>%
  group_by(Date, Organic) %>%
  dplyr::summarise(#median_val = median(SPM_mgperL), 
                   mean_val = mean(as.numeric(C_mgperL)), 
                   sd = sd(as.numeric(C_mgperL)))

print(test)

test = subset(C_Elbe.sum, Organic == "Total") %>%
  group_by(Date, Groups) %>%
  dplyr::summarise(#median_val = median(SPM_mgperL), 
                   mean_val = mean(as.numeric(C_mgperL)), 
                   sd = sd(as.numeric(C_mgperL)))

print(test)

test2 = test %>%
  group_by(Date) %>%
  dplyr::summarise(sum = sum(as.numeric(mean_val)))

print(test2)

library(vegan)


CarbonContributions.perc =  C_Elbe_UnstainedOnly.sum %>% 
  group_by(Station, Date) %>% 
  mutate(percent = C_mgperL/sum(C_mgperL))

CarbonContributions.perc.sum = CarbonContributions.perc %>%
  group_by(Groups) %>%
  dplyr::summarise(mean_val = mean(as.numeric(percent))*100, 
                   sd = sd(as.numeric(percent))*100)

print(CarbonContributions.perc.sum)


#Organic vs Inorganic Carbon


test =  C_Elbe_UnstainedOnly.sum %>% 
  group_by(Station, Date) %>% 
  mutate(percent = C_mgperL/sum(C_mgperL))
test

test.sum = test %>%
  group_by(Organic) %>%
  dplyr::summarise(mean_val = sum(as.numeric(percent))*100, 
                   sd = sd(as.numeric(percent))*100)
test.sum[1,2]/25 # Organic
test.sum[2,2]/25 # Inorganic

####Dissimilarity between unstained only vs all PAO####
Vegdist.df = data.frame("All_sample" = rownames(C_Elbe_All.sum),
                        "All_C" = C_Elbe_All.sum$C_mgperL,
                        "Unstained_sample" = rownames(C_Elbe_UnstainedOnly.sum),
                        "Unstained_C" = C_Elbe_UnstainedOnly.sum$C_mgperL)

AllVsUnstained.diss = vegdist(t(Vegdist.df[,c(2,4)]), method = "bray")

AllVsUnstained.diss




####Seasonal carbon contribution differences####

#Significant differences over station - TEP
CmgperL_model = aov(percent ~ Date * Groups, data = CarbonContributions.perc)
summary(CmgperL_model)
rstatix::eta_squared(CmgperL_model)


####Total dissolved vs total particulate ####

TotalC.df = subset(C_Elbe.sum, Organic=="Total")

TotalSuspendedC.df = subset(TotalC.df, Fraction=="Suspended Particles")
TotalSinkingC.df = subset(TotalC.df, Fraction=="Sinking Particles")
TotalDissolvedC.df = subset(TotalC.df, Fraction=="Dissolved")

dim(TotalSuspendedC.df)
dim(TotalSinkingC.df)
dim(TotalDissolvedC.df)

TotalSuspendedC.df = with(TotalSuspendedC.df, TotalSuspendedC.df[order(Station, Date),])
TotalSinkingC.df = with(TotalSinkingC.df, TotalSinkingC.df[order(Station, Date),])
TotalDissolvedC.df = with(TotalDissolvedC.df, TotalDissolvedC.df[order(Station, Date),])

TotalDissolvedC.df$ParticulateTotal = TotalSinkingC.df$C_mgperL + TotalSuspendedC.df$C_mgperL

TotalDissolvedC.df$ParticulateToDissolvedTotalC =  TotalDissolvedC.df$ParticulateTotal / TotalDissolvedC.df$C_mgperL

ggplot(TotalDissolvedC.df, aes(x = Station, y = ParticulateToDissolvedTotalC , colour = Date, group = Date))+
  geom_line()+
  My_Theme+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

stats.sum = TotalDissolvedC.df %>%
  group_by(Date) %>%
  dplyr::summarise(mean_val = mean(ParticulateToDissolvedTotalC), sd = sd(ParticulateToDissolvedTotalC))
print(stats.sum)
#mean
stats.sum = TotalDissolvedC.df %>%
  group_by() %>%
  dplyr::summarise(mean_val = mean(ParticulateToDissolvedTotalC), sd = sd(ParticulateToDissolvedTotalC))
print(stats.sum)

ParticulateToDissolvedC.mdl = aov(C_mgperL ~ Date, data = TotalDissolvedC.df)
summary(ParticulateToDissolvedC.mdl)
rstatix::eta_squared(ParticulateToDissolvedC.mdl)
pairwise.wilcox.test(TotalDissolvedC.df$C_mgperL, TotalDissolvedC.df$Date)

####Organic dissolved vs Organic particulate ####

OrganicC.df = subset(C_Elbe.sum, Organic=="Organic")

OrganicSuspendedC.df = subset(OrganicC.df, Fraction=="Suspended Particles")
OrganicSinkingC.df = subset(OrganicC.df, Fraction=="Sinking Particles")
OrganicDissolvedC.df = subset(OrganicC.df, Fraction=="Dissolved")

dim(OrganicSuspendedC.df)
dim(OrganicSinkingC.df)
dim(OrganicDissolvedC.df)

OrganicSuspendedC.df = with(OrganicSuspendedC.df, OrganicSuspendedC.df[order(Station, Date),])
OrganicSinkingC.df = with(OrganicSinkingC.df, OrganicSinkingC.df[order(Station, Date),])
OrganicDissolvedC.df = with(OrganicDissolvedC.df, OrganicDissolvedC.df[order(Station, Date),])

OrganicDissolvedC.df$ParticulateOrganic = OrganicSinkingC.df$C_mgperL + OrganicSuspendedC.df$C_mgperL

OrganicDissolvedC.df$ParticulateToDissolvedOrganicC =  OrganicDissolvedC.df$ParticulateOrganic / OrganicDissolvedC.df$C_mgperL

ggplot(OrganicDissolvedC.df, aes(x = Station, y = ParticulateToDissolvedOrganicC , colour = Date, group = Date))+
  geom_line()+
  My_Theme+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

stats.sum = OrganicDissolvedC.df %>%
  group_by(Date) %>%
  dplyr::summarise(mean_val = mean(ParticulateToDissolvedOrganicC), sd = sd(ParticulateToDissolvedOrganicC))
print(stats.sum)
#Mean
stats.sum = OrganicDissolvedC.df %>%
  group_by() %>%
  dplyr::summarise(mean_val = mean(ParticulateToDissolvedOrganicC), sd = sd(ParticulateToDissolvedOrganicC))
print(stats.sum)

ParticulateToDissolvedC.mdl = aov(C_mgperL ~ Date, data = OrganicDissolvedC.df)
summary(ParticulateToDissolvedC.mdl)
rstatix::eta_squared(ParticulateToDissolvedC.mdl)
pairwise.wilcox.test(OrganicDissolvedC.df$C_mgperL, OrganicDissolvedC.df$Date)

####Inorganic dissolved vs Inorganic particulate ####

InorganicC.df = subset(C_Elbe.sum, Organic=="Inorganic")

InorganicSuspendedC.df = subset(InorganicC.df, Fraction=="Suspended Particles")
InorganicSinkingC.df = subset(InorganicC.df, Fraction=="Sinking Particles")
InorganicDissolvedC.df = subset(InorganicC.df, Fraction=="Dissolved")

dim(InorganicSuspendedC.df)
dim(InorganicSinkingC.df)
dim(InorganicDissolvedC.df)

InorganicSuspendedC.df = with(InorganicSuspendedC.df, InorganicSuspendedC.df[order(Station, Date),])
InorganicSinkingC.df = with(InorganicSinkingC.df, InorganicSinkingC.df[order(Station, Date),])
InorganicDissolvedC.df = with(InorganicDissolvedC.df, InorganicDissolvedC.df[order(Station, Date),])

InorganicDissolvedC.df$ParticulateInorganic = InorganicSinkingC.df$C_mgperL + InorganicSuspendedC.df$C_mgperL

InorganicDissolvedC.df$ParticulateToDissolvedInorganicC =  InorganicDissolvedC.df$ParticulateInorganic / InorganicDissolvedC.df$C_mgperL

ggplot(InorganicDissolvedC.df, aes(x = Station, y = ParticulateToDissolvedInorganicC , colour = Date, group = Date))+
  geom_line()+
  My_Theme+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

stats.sum = InorganicDissolvedC.df %>%
  group_by(Date) %>%
  dplyr::summarise(mean_val = mean(ParticulateToDissolvedInorganicC), sd = sd(ParticulateToDissolvedInorganicC))
print(stats.sum)
#Mean
stats.sum = InorganicDissolvedC.df %>%
  group_by() %>%
  dplyr::summarise(mean_val = mean(ParticulateToDissolvedInorganicC), sd = sd(ParticulateToDissolvedInorganicC))
print(stats.sum)

ParticulateToDissolvedC.mdl = aov(C_mgperL ~ Date, data = InorganicDissolvedC.df)
summary(ParticulateToDissolvedC.mdl)
rstatix::eta_squared(ParticulateToDissolvedC.mdl)
pairwise.wilcox.test(InorganicDissolvedC.df$C_mgperL, InorganicDissolvedC.df$Date)


####Sinking and suspended particle organic:inorganic C####

OvsI_SuspC.df = OrganicSuspendedC.df$C_mgperL / InorganicSuspendedC.df$C_mgperL
OvsI_SinkC.df = OrganicSinkingC.df$C_mgperL / InorganicSinkingC.df$C_mgperL

OvsI_SuspC.tmp = OrganicSuspendedC.df[,c(1:3)]
OvsI_SuspC.tmp$C_mgperL = OvsI_SuspC.df

OvsI_SinkC.tmp = OrganicSinkingC.df[,c(1:3)]
OvsI_SinkC.tmp$C_mgperL = OvsI_SinkC.df

OvsI_SuspSinkC.df = rbind(OvsI_SuspC.tmp, OvsI_SinkC.tmp)

ggplot(OvsI_SuspSinkC.df, aes(x=Station, y = C_mgperL, colour = Fraction, group = Fraction))+
  geom_line()+
  scale_y_log10()+
  facet_wrap(Date ~ .)

rstatix::eta_squared(aov(C_mgperL ~ Fraction, data = OvsI_SuspSinkC.df))



```
###Combined - for relative C contributions

```{r}
####Prep work####

#Make sure names match for the same variables
colnames(CHN.Elbe.sum)
colnames(DOC.Elbe.sum)
colnames(SYBR_FL.sum)
colnames(PAO_sum_ACC.df)

#Match naming scheme
DOC.Elbe.sum$Organic = gsub(" Carbon_mg.L", "", DOC.Elbe.sum$Organic)
SYBR_FL.sum$Average_Size = NULL
SYBR_FL.sum$Corr_FL = NULL
SYBR_FL.sum$Count = NULL
SYBR_FL.sum$radius = NULL
SYBR_FL.sum$Mean_Volume = NULL
SYBR_FL.sum$FL_Carbon_fg = NULL
SYBR_FL.sum$C_mgperL = SYBR_FL.sum$FL_Carbon_ug / 1000
SYBR_FL.sum$FL_Carbon_ug = NULL
SYBR_FL.sum$Fraction = "Free_living"
SYBR_FL.sum$Organic = "Organic"
SYBR_FL.sum$Groups = paste0(SYBR_FL.sum$Fraction, SYBR_FL.sum$Organic)
PAO_sum_ACC.df$C_mgperL = PAO_sum_ACC.df$PAO_Carbon_ug / 1000
PAO_sum_ACC.df$PAO_Carbon_ug = NULL
PAO_sum_ACC.df$Organic = "Organic"
PAO_sum_ACC.df$Fraction = paste0("PAO ", PAO_sum_ACC.df$Fraction)
PAO_sum_ACC.df$Groups = paste0(PAO_sum_ACC.df$Fraction, PAO_sum_ACC.df$Organic, PAO_sum_ACC.df$Condition)
PAO_sum_ACC.df$Condition = NULL

#Make sure order is consistent
col_order <- c("Station", "Date", "Fraction", "Organic", "N", "C_mgperL", "sd", "se", "ci", "Groups")
CHN.Elbe.sum <- CHN.Elbe.sum[, col_order]
DOC.Elbe.sum <- DOC.Elbe.sum[, col_order]
SYBR_FL.sum <- SYBR_FL.sum[, col_order]
PAO_sum_ACC.df <- PAO_sum_ACC.df[, col_order]

#Make sure names match for the same variables
colnames(CHN.Elbe.sum)
colnames(DOC.Elbe.sum)
colnames(SYBR_FL.sum)
colnames(PAO_sum_ACC.df)

####Add inorganic to particulate carbon measurements####
CHN.Elbe.tmp = CHN.Elbe.sum
CHN.Elbe.tmp$Groups = NULL
CHN.Elbe.tmp$N = NULL
CHN.Elbe.tmp$sd = NULL
CHN.Elbe.tmp$se = NULL
CHN.Elbe.tmp$ci = NULL
#CHN.Elbe.tmp$Groups = NULL
CHN.Elbe.tmp


CHN.Elbe.wide = spread(CHN.Elbe.tmp, key = Organic, value = C_mgperL)
CHN.Elbe.wide

CHN.Elbe.wide$Inorganic = CHN.Elbe.wide$Total - CHN.Elbe.wide$Organic

CHN.Elbe.long <- gather(CHN.Elbe.wide, Organic, C_mgperL, Organic:Inorganic, factor_key=TRUE)
CHN.Elbe.long

CHN.Elbe.long.IO = merge(subset(CHN.Elbe.long, Organic!="Inorganic"), CHN.Elbe.sum, by = c("Station", "Date", "Fraction", "Organic", "C_mgperL"))

colnames(CHN.Elbe.long)
colnames(CHN.Elbe.long.IO)
CHN.Elbe.long$N = 1
CHN.Elbe.long$sd = NA
CHN.Elbe.long$se = NA
CHN.Elbe.long$ci = NA
CHN.Elbe.long$Groups = paste0(CHN.Elbe.long$Fraction, CHN.Elbe.long$Organic)

CHN.Elbe.sum = rbind(CHN.Elbe.long.IO, subset(CHN.Elbe.long, Organic=="Inorganic"))






####Subset PAO with Unstained and total####

PAO_sum_ACC_Unstained.df = subset(PAO_sum_ACC.df, Groups=="PAO SuspendedOrganicUnstained" | Groups=="PAO SinkingOrganicUnstained" )
PAO_sum_ACC_All.df = PAO_sum_ACC.df %>%
  group_by(Date, Station, Fraction) %>%
  dplyr::summarise(sum_val = sum(C_mgperL), sd = sd(C_mgperL))
print(PAO_sum_ACC_All.df)

colnames(PAO_sum_ACC_All.df)
colnames(PAO_sum_ACC_Unstained.df)

PAO_sum_ACC_All.df$Organic = "Organic"
PAO_sum_ACC_All.df$N = 1
PAO_sum_ACC_All.df$C_mgperL = PAO_sum_ACC_All.df$sum_val
PAO_sum_ACC_All.df$sum_val = NULL
PAO_sum_ACC_All.df$se = NA
PAO_sum_ACC_All.df$ci = NA
PAO_sum_ACC_All.df$Groups = paste0(PAO_sum_ACC_All.df$Fraction, PAO_sum_ACC_All.df$Organic)

colnames(PAO_sum_ACC_All.df)
colnames(PAO_sum_ACC_Unstained.df)


####Subtract PAO from Particle POC for both with and without exopolymer associated organisms####


CHN.Elbe.sum$Old_C_mgperL = CHN.Elbe.sum$C_mgperL
PAO_sum_ACC_Unstained.df
CHN.Elbe.sum

#CHN.Elbe.sum$Matches = "NA" # In case of bugs

i=1
x=31
for (x in 1:length(CHN.Elbe.sum$C_mgperL)) {
  
  OrganicID2 = CHN.Elbe.sum$Organic[x]
  StationID2 =  CHN.Elbe.sum$Station[x]
  DateID2 =  CHN.Elbe.sum$Date[x]
  FractionID2 = sapply(strsplit( as.character(CHN.Elbe.sum$Fraction), " " ), "[", 1 )[x]
    
  #print(paste0("Sample is ", StationID2, DateID2, FractionID2, OrganicID2))
  
  for (i in 1:length(PAO_sum_ACC_Unstained.df$C_mgperL)) {
    
    StationID = PAO_sum_ACC_Unstained.df$Station[i]
    DateID = PAO_sum_ACC_Unstained.df$Date[i]
    FractionID = sapply(strsplit( PAO_sum_ACC_Unstained.df$Fraction, " " ), "[", 2 )[i]
    
    #print(paste0("Sample is ", StationID, DateID, FractionID))
  
    if (grepl("Organic", OrganicID2) == T &
        grepl(StationID, StationID2) == T &
        grepl(DateID, DateID2) == T &
        grepl(FractionID, FractionID2) == T) {
      
      print(paste0("Match has been identified between rows CHN ", x, " and PAO ", i))
      
      CHN.Elbe.sum$C_mgperL[x] = CHN.Elbe.sum$Old_C_mgperL[x] - PAO_sum_ACC_Unstained.df$C_mgperL[i]
      #CHN.Elbe.sum$Matches[x] = "Matched" # In case of bugs
  }
    
  }
  
}

#Remove Old mg C per L column
CHN.Elbe.sum_UnstainedOnly = CHN.Elbe.sum[,-11]



PAO_sum_ACC_All.df
CHN.Elbe.sum

#CHN.Elbe.sum$Matches = "NA" # In case of bugs

i=2
x=31
for (x in 1:length(CHN.Elbe.sum$C_mgperL)) {
  
  OrganicID2 = CHN.Elbe.sum$Organic[x]
  StationID2 =  CHN.Elbe.sum$Station[x]
  DateID2 =  CHN.Elbe.sum$Date[x]
  FractionID2 = sapply(strsplit( as.character(CHN.Elbe.sum$Fraction), " " ), "[", 1 )[x]
    
  #print(paste0("Sample is ", StationID2, DateID2, FractionID2, OrganicID2))
  
  for (i in 1:length(PAO_sum_ACC_All.df$C_mgperL)) {
    
    StationID = PAO_sum_ACC_All.df$Station[i]
    DateID = PAO_sum_ACC_All.df$Date[i]
    FractionID = sapply(strsplit( PAO_sum_ACC_All.df$Fraction, " " ), "[", 2 )[i]
    
    #print(paste0("Sample is ", StationID, DateID, FractionID))
  
    if (grepl("Organic", OrganicID2) == T &
        grepl(StationID, StationID2) == T &
        grepl(DateID, DateID2) == T &
        grepl(FractionID, FractionID2) == T) {
      
      print(paste0("Match has been identified between rows CHN ", x, " and PAO ", i))
      
      CHN.Elbe.sum$C_mgperL[x] = CHN.Elbe.sum$Old_C_mgperL[x] - PAO_sum_ACC_All.df$C_mgperL[i]
      #CHN.Elbe.sum$Matches[x] = "Matched" # In case of bugs
  }
    
  }
  
}

CHN.Elbe.sum_All = CHN.Elbe.sum[,-11]


####Merge data frames####

#Need to remove all 2021.05, as don't have the complete dataset




#Make sure names match for the same variables
colnames(CHN.Elbe.sum_All)
colnames(CHN.Elbe.sum_UnstainedOnly)
colnames(DOC.Elbe.sum)
colnames(SYBR_FL.sum)
colnames(PAO_sum_ACC_All.df)
colnames(PAO_sum_ACC_Unstained.df)
         
#Actual merge
C_Elbe_All.sum = rbind(CHN.Elbe.sum_All, 
                       DOC.Elbe.sum, 
                       SYBR_FL.sum, 
                       PAO_sum_ACC_All.df)
C_Elbe_UnstainedOnly.sum = rbind(CHN.Elbe.sum_UnstainedOnly, 
                                 DOC.Elbe.sum, 
                                 SYBR_FL.sum, 
                                 PAO_sum_ACC_Unstained.df)


C_Elbe_All.sum$Fraction = factor(C_Elbe_All.sum$Fraction,
                                levels = c("Dissolved",
                                           "Free_living",
                                           "PAO Suspended",
                                           "PAO Sinking",
                                           "Suspended Particles",
                                           "Sinking Particles"))
C_Elbe_UnstainedOnly.sum$Fraction = factor(C_Elbe_UnstainedOnly.sum$Fraction,
                                levels = c("Dissolved",
                                           "Free_living",
                                           "PAO Suspended",
                                           "PAO Sinking",
                                           "Suspended Particles",
                                           "Sinking Particles"))

C_Elbe_All.sum = subset(C_Elbe_All.sum, Organic!="Total" & Date!="2021.05" & Date!="2021.11")
C_Elbe_UnstainedOnly.sum = subset(C_Elbe_UnstainedOnly.sum, Organic!="Total" & Date!="2021.05" & Date!="2021.11")


C_Elbe_All.sum$Organic = factor(C_Elbe_All.sum$Organic,
                                levels = c("Organic",
                                           "Inorganic"))
C_Elbe_UnstainedOnly.sum$Organic = factor(C_Elbe_UnstainedOnly.sum$Organic,
                                levels = c("Organic",
                                           "Inorganic"))

#Control for NA values
C_Elbe_All.sum$C_mgperL[is.na(C_Elbe_All.sum$C_mgperL)] <- 0
C_Elbe_UnstainedOnly.sum$C_mgperL[is.na(C_Elbe_UnstainedOnly.sum$C_mgperL)] <- 0

#Remove <0 values as they are nonsensical
C_Elbe_All.sum$C_mgperL[C_Elbe_All.sum$C_mgperL < 0] = 0
C_Elbe_UnstainedOnly.sum$C_mgperL[C_Elbe_UnstainedOnly.sum$C_mgperL < 0] = 0

#Clean up text labels
C_Elbe_All.sum$Groups = gsub("Sinking ParticlesOrganic", "Sinking Organic Particles", C_Elbe_All.sum$Groups)
C_Elbe_All.sum$Groups = gsub("Suspended ParticlesOrganic", "Suspended Organic Particles", C_Elbe_All.sum$Groups)
C_Elbe_All.sum$Groups = gsub("Sinking ParticlesInorganic", "Sinking Inorganic Particles", C_Elbe_All.sum$Groups)
C_Elbe_All.sum$Groups = gsub("Suspended ParticlesInorganic", "Suspended Inorganic Particles", C_Elbe_All.sum$Groups)
C_Elbe_All.sum$Groups = gsub("DissolvedOrganic Carbon_mg.L", "Dissolved Organic", C_Elbe_All.sum$Groups)
C_Elbe_All.sum$Groups = gsub("DissolvedInorganic Carbon_mg.L", "Dissolved Inorganic", C_Elbe_All.sum$Groups)
C_Elbe_All.sum$Groups = gsub("Free_livingOrganic", "Free-Living Organisms", C_Elbe_All.sum$Groups)
C_Elbe_All.sum$Groups = gsub("PAO SinkingOrganic", "Sinking PAO", C_Elbe_All.sum$Groups)
C_Elbe_All.sum$Groups = gsub("PAO SuspendedOrganic", "Suspended PAO", C_Elbe_All.sum$Groups)
C_Elbe_UnstainedOnly.sum$Groups = gsub("Sinking ParticlesOrganic", "Sinking Organic Particles", C_Elbe_UnstainedOnly.sum$Groups)
C_Elbe_UnstainedOnly.sum$Groups = gsub("Suspended ParticlesOrganic", "Suspended Organic Particles", C_Elbe_UnstainedOnly.sum$Groups)
C_Elbe_UnstainedOnly.sum$Groups = gsub("Sinking ParticlesInorganic", "Sinking Inorganic Particles", C_Elbe_UnstainedOnly.sum$Groups)
C_Elbe_UnstainedOnly.sum$Groups = gsub("Suspended ParticlesInorganic", "Suspended Inorganic Particles", C_Elbe_UnstainedOnly.sum$Groups)
C_Elbe_UnstainedOnly.sum$Groups = gsub("DissolvedOrganic Carbon_mg.L", "Dissolved Organic", C_Elbe_UnstainedOnly.sum$Groups)
C_Elbe_UnstainedOnly.sum$Groups = gsub("DissolvedInorganic Carbon_mg.L", "Dissolved Inorganic", C_Elbe_UnstainedOnly.sum$Groups)
C_Elbe_UnstainedOnly.sum$Groups = gsub("Free_livingOrganic", "Free-Living Organisms", C_Elbe_UnstainedOnly.sum$Groups)
C_Elbe_UnstainedOnly.sum$Groups = gsub("PAO SinkingOrganicUnstained", "Sinking PAO", C_Elbe_UnstainedOnly.sum$Groups)
C_Elbe_UnstainedOnly.sum$Groups = gsub("PAO SuspendedOrganicUnstained", "Suspended PAO", C_Elbe_UnstainedOnly.sum$Groups)

#Reorder text labels
C_Elbe_All.sum$Groups = factor(C_Elbe_All.sum$Groups,
                                levels = c("Dissolved Organic",
                                           "Dissolved Inorganic",
                                           "Free-Living Organisms",
                                           "Suspended PAO",
                                           "Sinking PAO",
                                           "Suspended Organic Particles",
                                           "Suspended Inorganic Particles",
                                           "Sinking Organic Particles",
                                           "Sinking Inorganic Particles"
                                           ))
C_Elbe_UnstainedOnly.sum$Groups = factor(C_Elbe_UnstainedOnly.sum$Groups,
                                levels = c("Dissolved Organic",
                                           "Dissolved Inorganic",
                                           "Free-Living Organisms",
                                           "Suspended PAO",
                                           "Sinking PAO",
                                           "Suspended Organic Particles",
                                           "Suspended Inorganic Particles",
                                           "Sinking Organic Particles",
                                           "Sinking Inorganic Particles"
                                           ))

C_Elbe_All.sum$Stromkilometer = C_Elbe_All.sum$Station
#Get distance from Hamburg/Elbe distance for spearman tests
C_Elbe_All.sum$Stromkilometer = gsub("Muhlenberger Loch", 633, C_Elbe_All.sum$Stromkilometer)
C_Elbe_All.sum$Stromkilometer = gsub("Twielenfleth", 651, C_Elbe_All.sum$Stromkilometer)
C_Elbe_All.sum$Stromkilometer = gsub("Schwarztonnensand", 665, C_Elbe_All.sum$Stromkilometer)
C_Elbe_All.sum$Stromkilometer = gsub("Brunsbuttel", 694, C_Elbe_All.sum$Stromkilometer)
C_Elbe_All.sum$Stromkilometer = gsub("Meedem Grund", 712, C_Elbe_All.sum$Stromkilometer)
C_Elbe_All.sum = subset(C_Elbe_All.sum, Station!="NEGATIVE" & Station!="BunthausSpitze")

C_Elbe_All.sum$Stromkilometer = factor(C_Elbe_All.sum$Stromkilometer,
                                levels = c("712",
                                           "694",
                                           "665",
                                           "651",
                                           "633"
                                           ))


C_Elbe_UnstainedOnly.sum$Stromkilometer = C_Elbe_UnstainedOnly.sum$Station
#Get distance from Hamburg/Elbe distance for spearman tests
C_Elbe_UnstainedOnly.sum$Stromkilometer = gsub("Muhlenberger Loch", 633, C_Elbe_UnstainedOnly.sum$Stromkilometer)
C_Elbe_UnstainedOnly.sum$Stromkilometer = gsub("Twielenfleth", 651, C_Elbe_UnstainedOnly.sum$Stromkilometer)
C_Elbe_UnstainedOnly.sum$Stromkilometer = gsub("Schwarztonnensand", 665, C_Elbe_UnstainedOnly.sum$Stromkilometer)
C_Elbe_UnstainedOnly.sum$Stromkilometer = gsub("Brunsbuttel", 694, C_Elbe_UnstainedOnly.sum$Stromkilometer)
C_Elbe_UnstainedOnly.sum$Stromkilometer = gsub("Meedem Grund", 712, C_Elbe_UnstainedOnly.sum$Stromkilometer)
C_Elbe_UnstainedOnly.sum = subset(C_Elbe_UnstainedOnly.sum, Station!="NEGATIVE" & Station!="BunthausSpitze")

C_Elbe_UnstainedOnly.sum$Stromkilometer = factor(C_Elbe_UnstainedOnly.sum$Stromkilometer,
                                levels = c("712",
                                           "694",
                                           "665",
                                           "651",
                                           "633"
                                           ))


#Change date to fit other figures
C_Elbe_All.sum$Date = gsub("2021.07", "Jul-21", C_Elbe_All.sum$Date)
C_Elbe_All.sum$Date = gsub("2022.02", "Feb 22", C_Elbe_All.sum$Date)
C_Elbe_All.sum$Date = gsub("2022.05", "May 22", C_Elbe_All.sum$Date)
C_Elbe_All.sum$Date = gsub("2022.06", "Jun 22", C_Elbe_All.sum$Date)
C_Elbe_All.sum$Date = gsub("2022.11", "Nov 22", C_Elbe_All.sum$Date)
C_Elbe_All.sum$Date = factor(C_Elbe_All.sum$Date,
                                levels = c("Jul-21",
                                           "Feb 22",
                                           "May 22",
                                           "Jun 22",
                                           "Nov 22"
                                           ))



####Actual plotting####
C_Elbe_All.sum = subset(C_Elbe_All.sum, Organic=="Organic")
TC_Contribution_All.plt =  ggplot(subset(C_Elbe_All.sum, Date!="Jul-21"), 
                                  aes(x = as.factor(Stromkilometer), 
                                      y = C_mgperL, 
                                      fill = Groups, 
                                      group = Groups))+
  geom_bar(position = "fill", 
           stat = "identity", 
           size = 1)+
  facet_grid(Date ~ .)+
  scale_fill_manual("Carbon type", 
                    values = Group_colours)+
  scale_y_continuous(breaks = seq(0, 1, by = 0.5), labels = scales::percent_format())+ # Draw ggplot2 plot scaled to 100%
  xlab("Elbe kilometer")+
  ylab("Carbon contribution")+
  Poster_Theme+
  theme(axis.text.x = element_text(angle = 45, 
                                   hjust = 1),
        #panel.background = element_rect(fill = '#eff1f2'),
         #                  legend.key = element_rect(fill = "#eff1f2"),
          #                 plot.background = element_rect(fill = "#eff1f2"),
           #                legend.background = element_rect(fill = "#eff1f2"),
        legend.position = "bottom")
TC_Contribution_All.plt


#Save plot
tiff("TotalCarbonPerc.tiff", units = "in", width = 16, height = 10, res = 120)
TC_Contribution_All.plt
dev.off()

png("TotalCarbonPerc.png",  units = "in", width = 16, height = 10, res = 120)
TC_Contribution_All.plt
dev.off()


```
####Statistics and numbers
```{r}
test = C_Elbe_All.sum %>%
  group_by(Date, Groups) %>%
  dplyr::summarise(#median_val = median(SPM_mgperL), 
                   mean_val = mean(as.numeric(C_mgperL)), 
                   sd = sd(as.numeric(C_mgperL)))

print(test)

#Group variations
test = C_Elbe_All.sum %>%
  group_by(Groups) %>%
  dplyr::summarise(#median_val = median(SPM_mgperL), 
                   mean_val = mean(as.numeric(C_mgperL)), 
                   sd = sd(as.numeric(C_mgperL)))

print(test)

library(vegan)


CarbonContributions.perc =  C_Elbe_UnstainedOnly.sum %>% 
  group_by(Station, Date) %>% 
  mutate(percent = C_mgperL/sum(C_mgperL))

CarbonContributions.perc.sum = CarbonContributions.perc %>%
  group_by(Groups) %>%
  dplyr::summarise(mean_val = mean(as.numeric(percent))*100, 
                   sd = sd(as.numeric(percent))*100)

print(CarbonContributions.perc.sum)


#Organic vs Inorganic Carbon


test =  C_Elbe_UnstainedOnly.sum %>% 
  group_by(Station, Date) %>% 
  mutate(percent = C_mgperL/sum(C_mgperL))
test

test.sum = test %>%
  group_by(Organic) %>%
  dplyr::summarise(mean_val = sum(as.numeric(percent))*100, 
                   sd = sd(as.numeric(percent))*100)
test.sum[1,2]/25 # Organic
test.sum[2,2]/25 # Inorganic

####Dissimilarity between unstained only vs all PAO####
Vegdist.df = data.frame("All_sample" = rownames(C_Elbe_All.sum),
                        "All_C" = C_Elbe_All.sum$C_mgperL,
                        "Unstained_sample" = rownames(C_Elbe_UnstainedOnly.sum),
                        "Unstained_C" = C_Elbe_UnstainedOnly.sum$C_mgperL)

AllVsUnstained.diss = vegdist(t(Vegdist.df[,c(2,4)]), method = "bray")

AllVsUnstained.diss




####Seasonal carbon contribution differences####

#Significant differences over station - TEP
CmgperL_model = aov(percent ~ Date * Groups, data = CarbonContributions.perc)
summary(CmgperL_model)
rstatix::eta_squared(CmgperL_model)


```







#Figure 6 - DOM PCA - in EEM_PARAFAC script
#Figure 7 - in EEM_PARAFAC script
#Figure 8 - Directly comparing TEP/CSP/Visible Particle Area with PAO 
##TEP vs CSP
```{r}

colnames(Merged_Fig.df)
dim(Merged_Fig.df)


TEPvsCSP.df = spread(Merged_Fig.df[,c(1:3,5,14:15)], Condition, CorrAreaL)

TEPvsCSP.df

TEPvsCSP.stat = cor.test(TEPvsCSP.df$TEP, TEPvsCSP.df$CSP, method = "s")

TEPvsCSP.plt = ggplot(TEPvsCSP.df, aes(y = TEP, x = CSP))+
  geom_point()+
  #geom_smooth()+
  #ggtitle("Particle TEP vs CSP areas \n(um per L)")+ 
  xlab("CSP (um per L)")+
  ylab("TEP (um per L)")+
  geom_smooth(method='lm', formula= y~x)+
  annotate("text", label = paste0("p = ", round(TEPvsCSP.stat$p.value, digits = 3), "\n", "rho = ", round(TEPvsCSP.stat$estimate, digits = 3)), x = 0, y = 20000000000, hjust = 0)+
  My_Theme +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
TEPvsCSP.plt



ggplotRegression <- function (fit) {

require(ggplot2)

ggplot(fit$model, aes_string(x = names(fit$model)[2], y = names(fit$model)[1])) + 
  geom_point() +
  stat_smooth(method = "lm", col = "red") +
  labs(title = paste("Adj R2 = ",signif(summary(fit)$adj.r.squared, 5),
                     "Intercept =",signif(fit$coef[[1]],5 ),
                     " Slope =",signif(fit$coef[[2]], 5),
                     " P =",signif(summary(fit)$coef[2,4], 5)))
}

ggplotRegression(lm(TEP ~ CSP, data = TEPvsCSP.df))

shapiro.test(TEPvsCSP.df$TEP)
shapiro.test(TEPvsCSP.df$CSP)

```
##TEP & CSP vs Bacteria

```{r}
#Use data from SYBR summary, as it isn't unstained vs TEP vs CSP specific
SYBR.df = read.csv("YOU/PATH/HERE/Data/AllSYBR_Summary.csv")

SYBR_Particles.df = subset(SYBR.df, Condition!="0point2" & Date!="2021.11")
SYBR_Particles.df$Count = SYBR_Particles.df$Count * 10122.6872775 * 1000

####Make plot pretty####
#Rename stations for pretty plots
SYBR_Particles.df$Station = gsub("Station2$", "Muhlenberger Loch", SYBR_Particles.df$Station)
SYBR_Particles.df$Station = gsub("Station3$", "Twielenfleth", SYBR_Particles.df$Station)
SYBR_Particles.df$Station = gsub("Station4$", "Schwarztonnensand", SYBR_Particles.df$Station)
SYBR_Particles.df$Station = gsub("Station5$", "Brunsbuttel", SYBR_Particles.df$Station)
SYBR_Particles.df$Station = gsub("Station6$", "Meedem Grund", SYBR_Particles.df$Station)
#SYBR_Particles.df$Station = gsub("Station1.5$", "SeemanshÃ¶ft", SYBR_Particles.df$Station)
#SYBR_Particles.df$Station = gsub("Station4.1$", "Kollmar", SYBR_Particles.df$Station)

SYBR_Particles.df$Stromkilometer = SYBR_Particles.df$Station

#Get distance from Hamburg/Elbe distance for spearman tests
SYBR_Particles.df$Stromkilometer = gsub("Muhlenberger Loch", 633, SYBR_Particles.df$Stromkilometer)
SYBR_Particles.df$Stromkilometer = gsub("Twielenfleth", 651, SYBR_Particles.df$Stromkilometer)
SYBR_Particles.df$Stromkilometer = gsub("Schwarztonnensand", 665, SYBR_Particles.df$Stromkilometer)
SYBR_Particles.df$Stromkilometer = gsub("Brunsbuttel", 694, SYBR_Particles.df$Stromkilometer)
SYBR_Particles.df$Stromkilometer = gsub("Meedem Grund", 712, SYBR_Particles.df$Stromkilometer)
#SYBR_Particles.df$Stromkilometer = gsub("SeemanshÃ¶ft", 629, SYBR_Particles.df$Stromkilometer)
#SYBR_Particles.df$Stromkilometer = gsub("Kollmar", 665, SYBR_Particles.df$Stromkilometer)

SYBR_Particles.df$Stromkilometer = as.numeric(as.character(SYBR_Particles.df$Stromkilometer))

SYBR_Particles.df$Station = factor(SYBR_Particles.df$Station,
                             levels = c("Meedem Grund", 
                                        "Brunsbuttel",
                                        #"Kollmar",
                                        "Schwarztonnensand",
                                        "Twielenfleth",
                                        "Muhlenberger Loch"#,
                                        #"SeemanshÃ¶ft"
                                        ))

SYBR_Particles.df$Fraction = gsub("Light", "Suspended", SYBR_Particles.df$Fraction)
SYBR_Particles.df$Fraction = gsub("Heavy", "Sinking", SYBR_Particles.df$Fraction)
SYBR_Particles.df$Fraction = gsub("0point2", "0.2 filtered", SYBR_Particles.df$Fraction)
SYBR_Particles.df$Fraction = factor(SYBR_Particles.df$Fraction,
                             levels = c("Suspended", "Sinking", "0.2 filtered"))

SYBR_Particles.df$Condition = gsub("AlcianBlue", "TEP", SYBR_Particles.df$Condition)
SYBR_Particles.df$Condition = gsub("CBBG", "CSP", SYBR_Particles.df$Condition)
SYBR_Particles.df$Condition = gsub("Particle", "Unstained", SYBR_Particles.df$Condition)
SYBR_Particles.df$Condition = gsub("0point2", "Unstained 0.2Âµm filtered", SYBR_Particles.df$Condition)
SYBR_Particles.df$Condition = factor(SYBR_Particles.df$Condition,
                             levels = c("Unstained", "Unstained 0.2Âµm filtered", "TEP", "CSP"))

#Fix date format for easier plotting
SYBR_Particles.df$Date = gsub("2021.07", "Jul 21", SYBR_Particles.df$Date)
SYBR_Particles.df$Date = gsub("2021.11", "Nov 21", SYBR_Particles.df$Date)
SYBR_Particles.df$Date = gsub("2022.02", "Feb 22", SYBR_Particles.df$Date)
SYBR_Particles.df$Date = gsub("2022.05", "May 22", SYBR_Particles.df$Date)
SYBR_Particles.df$Date = gsub("2022.06", "Jun 22", SYBR_Particles.df$Date)
SYBR_Particles.df$Date = gsub("2022.11", "Nov 22", SYBR_Particles.df$Date)


SYBR_Particles.df$Date = factor(SYBR_Particles.df$Date,
                                              levels = c("Jul 21",
                                                         "Nov 21",
                                                         "Feb 22",
                                                         "May 22",
                                                         "Jun 22",
                                                         "Nov 22"))

SYBR_Particles.sum = Rmisc::summarySE(SYBR_Particles.df,
                                      measurevar = "Count",
                                      groupvars = c("Station",
                                                    "Date",
                                                    "Fraction"))

SYBR_Particles.sum$N = NULL
SYBR_Particles.sum$sd = NULL
SYBR_Particles.sum$se = NULL
SYBR_Particles.sum$ci = NULL

ggplot(SYBR_Particles.sum, aes(x = Station, y = Count))+
  geom_point()+
  facet_grid(Date ~ Fraction)


SYBR_Particles.sum = spread(SYBR_Particles.sum, Condition, Count)


SYBR_Particles.sum
SYBR_Particles.sum$PAO_perL = SYBR_Particles.sum$Count
SYBR_Particles.sum$Count = NULL
colnames(SYBR_Particles.sum)
TEPvsCSP.df
colnames(TEPvsCSP.df)
TEPvsCSP.df$Date = TEPvsCSP.df$Sample_date
TEPvsCSP.df$Sample_date = NULL
TEPvsCSP.df$Season = NULL


StainsVsPAO.df = merge(SYBR_Particles.sum, TEPvsCSP.df, by = c("Station", "Date", "Fraction"))


TEPVsPAO.stat = cor.test(StainsVsPAO.df$TEP, StainsVsPAO.df$PAO_perL, method = "s")

TEPvsPAO.plt = ggplot(StainsVsPAO.df, aes(y = TEP, x = PAO_perL))+
  geom_point()+
  geom_smooth(method='lm', formula= y~x, colour = "black")+
  #ggtitle("Particle TEP (um per L) vs Particle \nassociated organisms (per L)")+
  ylab(expression(TEP~conc.~"(Âµm"^2*~L^"-1"*")"))+
  #ylab(expression(atop(TEP~conc.,
   #               "(Âµm"^2*~L^"-1"*")")))+
  #xlab(expression(Particle~associated~organisms,
   #               "(L"^"-1"*")"))+
  annotate("text", label = paste0("p < 0.001", "\n", "rho = ", round(TEPVsPAO.stat$estimate, digits = 3)), x =50000000, y = 23000000000, hjust = 0)+
  scale_y_continuous(breaks = c(0.0e+00, 1.0e+10, 2.0e+10))+
  Poster_Theme+
  theme(#axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.x = element_blank(),
    axis.text.x = element_blank())
TEPvsPAO.plt


CSPVsPAO.stat = cor.test(StainsVsPAO.df$CSP, StainsVsPAO.df$PAO_perL, method = "s")

CSPvsPAO.plt = ggplot(StainsVsPAO.df, aes(y = CSP, x = PAO_perL))+
  geom_point()+
  geom_smooth(method='lm', formula= y~x, colour = "black")+
  #ggtitle("Particle CSP (um per L) vs Particle associated organisms (per L)")+
  ylab(expression(CSP~"&"~TEP~conc.~"(Âµm"^2*~L^"-1"*")"))+
  xlab(expression(TEP~"&"~CSP~associated~bacteria~"(L"^"-1"*")"))+
  annotate("text", label = paste0("p = ", round(CSPVsPAO.stat$p.value, digits = 3), "\n", "rho = ", round(CSPVsPAO.stat$estimate, digits = 3)), x = 50000000, y = 19000000000, hjust = 0)+
  scale_y_continuous(breaks = c(0.0e+00, 1.0e+10, 2.0e+10))+
  Poster_Theme
  #theme(axis.text.x = element_text(angle = 45, hjust = 1))+
CSPvsPAO.plt


ggarrange(TEPvsPAO.plt,
          CSPvsPAO.plt,
          heights = c(1,1.3),
          nrow = 2)


#Save plot
pdf("TEPCSPvsPAO.pdf", height = 7, width = 9)
last_plot()
dev.off()


```
##TEP & CSP vs Particle area

```{r}

ParticleAreaVsStains.df = merge(ParticleAreaVsPAO.df[-13,], StainsVsPAO.df, by = c("Station", "Date", "Fraction", "PAO_perL"))


ParticleAreaVsTEP.stat = cor.test(ParticleAreaVsStains.df$TEP, ParticleAreaVsStains.df$CorrAreaL, method = "s")

ParticleAreaVsTEP.plt = ggplot(ParticleAreaVsStains.df, aes(y = TEP, x = CorrAreaL))+
  geom_point()+
  geom_smooth(method='lm', formula= y~x)+
  #ggtitle("Visible particle area (um per L) vs Particle associated organisms (per L)")+
  ylab("TEP (um per L)")+
  xlab("Visible particle area (um per L)")+
  annotate("text", 
           label = paste0("p = ", 
                          round(ParticleAreaVsTEP.stat$p.value, 
                                                digits = 3), 
                                  "\nrho = ", 
                                  round(ParticleAreaVsStains.stat$estimate, 
                                        digits = 3)), 
           x = 1000000000, 
           y = 23000000000, 
           hjust = 0)+
  My_Theme+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
ParticleAreaVsTEP.plt


ParticleAreaVsCSP.stat = cor.test(ParticleAreaVsStains.df$CSP, ParticleAreaVsStains.df$CorrAreaL, method = "s")

ParticleAreaVsCSP.plt = ggplot(ParticleAreaVsStains.df, aes(y = CSP, x = CorrAreaL))+
  geom_point()+
  geom_smooth(method='lm', formula= y~x)+
  #ggtitle("Visible particle area (um per L) vs Particle associated organisms (per L)")+
  ylab("CSP (um per L)")+
  xlab("Visible particle area (um per L)")+
  annotate("text", 
           label = paste0("p = ", 
                          round(ParticleAreaVsCSP.stat$p.value, 
                                                digits = 3), 
                                  "\nrho = ", 
                                  round(ParticleAreaVsStains.stat$estimate, 
                                        digits = 3)), 
           x = 1000000000, 
           y = 18000000000, 
           hjust = 0)+
  My_Theme+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ParticleAreaVsCSP.plt

```
##Particle Area vs PAO

```{r}

colnames(Merged_Fig.df)
dim(Merged_Fig.df)


ParticleArea.df = Merged_Fig.df[,c(1:3,8)]

ParticleArea.df
ParticleArea.df$Date = ParticleArea.df$Sample_date
ParticleArea.df$Sample_date = NULL


ParticleArea.plt = ggplot(ParticleArea.df, aes(x = Station, y = CorrAreaL, colour = Date, group = Date))+
  geom_point()+
  geom_smooth()
ParticleArea.plt


ParticleAreaVsPAO.df = merge(SYBR_Particles.sum, ParticleArea.df, by = c("Station", "Date", "Fraction"))


ParticleAreaVsPAO.stat = cor.test(ParticleAreaVsPAO.df$CorrAreaL, ParticleAreaVsPAO.df$PAO_perL, method = "s")

ParticleAreavsPAO.plt = ggplot(ParticleAreaVsPAO.df, aes(y = CorrAreaL, x = PAO_perL))+
  geom_point()+
  geom_smooth(method='lm', formula= y~x)+
  #ggtitle("Visible particle area (um per L) vs Particle associated organisms (per L)")+
  ylab("Visible particle area (um per L)")+
  xlab("Particle associated \norganisms (per L)")+
  annotate("text", label = paste0("p = ", round(ParticleAreaVsPAO.stat$p.value, digits = 3), "\n", "rho = ", round(ParticleAreaVsPAO.stat$estimate, digits = 3)), x = 50000000, y = 56000000000, hjust = 0)+
  My_Theme+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
ParticleAreavsPAO.plt

####Alternative test ####

ggplotRegression(lm(CorrAreaL ~ PAO_perL, data = ParticleAreaVsPAO.df))

```



##Organise nicely

```{r}
Comparisons.plt = ggarrange(TEPvsCSP.plt,
                            TEPvsPAO.plt,
                            CSPvsPAO.plt,
                            ParticleAreaVsTEP.plt,
                            ParticleAreaVsCSP.plt,
                            ParticleAreavsPAO.plt)

Comparisons.plt

#Save plot
tiff("DirectComparisons.tiff", units = "in", width = 16, height = 8, res = 120)
Comparisons.plt
dev.off()

```



#Supplementary Figures
##Supplementary Figure 1 - TEP/CSP FDR 
Alcian Blue and CBBG False Discovery Rates

Alcian Blue in Feb 2022 is 50% of the correction rate. The other time points look good, just not this one. 
```{r Particle staining abundance correction}

####Initial FDR ####
#Import pristine dataframe
Brightfield_sum.df = read.csv("/YOUR/PATH/HERE/Data/AllBrightfield_Summary.csv", fileEncoding = "UTF-8-BOM")

FalseDiscovery_sum.df = read.csv("/YOUR/PATH/HERE/Data/AllFalseDiscovery_Summary.csv")

#Particle count per L = particle count in image * magnification effect (x630) with field of view * convert from 1 mL sample to L
#FalseDiscovery_sum.df$Count = FalseDiscovery_sum.df$Count * 10122.6872775 * 1000
#Brightfield_sum.df$Count = Brightfield_sum.df$Count * 10122.6872775 * 1000


FalseDiscovery_sum.df$CorrectionFor = paste0("CorrectionFor_", FalseDiscovery_sum.df$CorrectionFor)
colnames(FalseDiscovery_sum.df) = colnames(Brightfield_sum.df)

False_and_True.df = rbind(FalseDiscovery_sum.df, subset(Brightfield_sum.df, Condition=="AlcianBlue" | Condition=="CBBG"))

False_and_True.df$Station = gsub("Station2$", "MÃ¼hlenberger Loch", False_and_True.df$Station)
False_and_True.df$Station = gsub("Station3$", "Twielenfleth", False_and_True.df$Station)
False_and_True.df$Station = gsub("Station4$", "Schwarztonnensand", False_and_True.df$Station)
False_and_True.df$Station = gsub("Station5$", "BrunsbÃ¼ttel", False_and_True.df$Station)
False_and_True.df$Station = gsub("Station6$", "Meedem Grund", False_and_True.df$Station)
False_and_True.df$Station = gsub("Station1.5$", "SeemanshÃ¶ft", False_and_True.df$Station)
False_and_True.df$Station = gsub("Station4.1$", "Kollmar", False_and_True.df$Station)

False_and_True.df$Stromkilometer = False_and_True.df$Station

False_and_True.df$Stromkilometer = gsub("MÃ¼hlenberger Loch", 633, False_and_True.df$Stromkilometer)
False_and_True.df$Stromkilometer = gsub("Twielenfleth", 651, False_and_True.df$Stromkilometer)
False_and_True.df$Stromkilometer = gsub("Schwarztonnensand", 665, False_and_True.df$Stromkilometer)
False_and_True.df$Stromkilometer = gsub("BrunsbÃ¼ttel", 694, False_and_True.df$Stromkilometer)
False_and_True.df$Stromkilometer = gsub("Meedem Grund", 712, False_and_True.df$Stromkilometer)
False_and_True.df$Stromkilometer = gsub("SeemanshÃ¶ft", 629, False_and_True.df$Stromkilometer)
False_and_True.df$Stromkilometer = gsub("Kollmar", 665, False_and_True.df$Stromkilometer)

False_and_True.df$Stromkilometer = as.numeric(as.character(False_and_True.df$Stromkilometer))

False_and_True.df$Station = factor(False_and_True.df$Station,
                             levels = c("Meedem Grund", 
                                        "BrunsbÃ¼ttel",
                                        "Kollmar",
                                        "Schwarztonnensand",
                                        "Twielenfleth",
                                        "MÃ¼hlenberger Loch",
                                        "SeemanshÃ¶ft"))

False_and_True.df$Fraction = gsub("Light", "Suspended", False_and_True.df$Fraction)
False_and_True.df$Fraction = gsub("Heavy", "Sinking", False_and_True.df$Fraction)
False_and_True.df$Fraction = factor(False_and_True.df$Fraction,
                             levels = c("Suspended", "Sinking"))

False_and_True.df$Date = factor(False_and_True.df$Date,
                             levels = c("7.2021", "11.2021", "2.2022"))


FalseDiscovery_sum_Control_ab.plot = ggplot(False_and_True.df, aes(y = Count, x = Stromkilometer, colour = Condition, group = Condition)) +
  geom_smooth()+
  #scale_y_log10()+
  facet_grid(. ~ Fraction)+
  scale_color_manual("Staining", values = cbbPalette)+
  theme_bw() +
  My_Theme +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ylab("Particles per Image")+
  xlab("Elbe km")
FalseDiscovery_sum_Control_ab.plot

pdf("/YOUR/PATH/HERE/SupplementaryFigure1.pdf", width = 12, height = 8)
FalseDiscovery_sum_Control_ab.plot
dev.off()

```

##Supplementary Figure 3 - Elbe flow rate/Discharge 
```{r}
#Import data
Discharge.df = read.csv("/YOUR/PATH/HERE/Data/riverdischarge_Neudarchau.csv", sep = ";")
head(Discharge.df)

#Subset to 2022
Discharge22.df = subset(Discharge.df, Year == "2022")

#make date column ggplot2 readable
Discharge22.df$Date = Discharge22.df$Datum_Uhrzeit
Discharge22.df$Date <- as.Date(Discharge22.df$Date, format = "%d.%m.%y")
Discharge22.df$Date

ggplot(Discharge22.df, aes(x=Date, y = Abfluss..m3.s.))+
  geom_point()+
  ylab(expression(Discharge~rate~"(m"^3*s^"-1"*")"))+
  My_Theme


png("/YOUR/PATH/HERE/SupplementaryFigure3_Elbe dischargerate.png", units = "in", width = 7, height = 5, res = 150)
last_plot()
dev.off()

tiff("/YOUR/PATH/HERE/SupplementaryFigure3_Elbe dischargerate.tiff", units = "in", width = 7, height = 5, res = 150)
last_plot()
dev.off()

pdf("/YOUR/PATH/HERE/SupplementaryFigure3_Elbe dischargerate.pdf", width = 7, height = 5)
last_plot()
dev.off()


```

##Supplementary Figure 4 - C/SPM ratio 
###CHN
```{r}

CHN.Elbe = CHN.Elbe_v0
unique(CHN.Elbe$Date)


CHN.Elbe$Date = gsub("May.2021", "May 21", CHN.Elbe$Date)
CHN.Elbe$Date = gsub("Jul.2021", "Jul 21", CHN.Elbe$Date)
CHN.Elbe$Date = gsub("Feb.2022", "Feb 22", CHN.Elbe$Date)
CHN.Elbe$Date = gsub("May.2022", "May 22", CHN.Elbe$Date)
CHN.Elbe$Date = gsub("Jun.2022", "Jun 22", CHN.Elbe$Date)
CHN.Elbe$Date = gsub("Nov.2022", "Nov 22", CHN.Elbe$Date)

CHN.Elbe$Date = factor(CHN.Elbe$Date,
                                levels = c("May 21",
                                           "Jul 21",
                                           "Feb 22",
                                           "May 22",
                                           "Jun 22",
                                           "Nov 22"))

CHN.Elbe$Station = factor(CHN.Elbe$Station,
                                levels = c("Meedem Grund",
                                           "Brunsbuttel",
                                           "Schwarztonnensand",
                                           "Twielenfleth",
                                           "Muhlenberger Loch"))

CHN.Elbe$Fraction = gsub("Light", "Suspended", CHN.Elbe$Fraction)
CHN.Elbe$Fraction = gsub("Heavy", "Sinking", CHN.Elbe$Fraction)

CHN.Elbe$Fraction = factor(CHN.Elbe$Fraction,
                                levels = c("Suspended",
                                           "Sinking"))

CHN.Elbe.sum = Rmisc::summarySE(CHN.Elbe, 
                                measurevar = "C_mgperL",
                                groupvars = c("Station",
                                              "Fraction",
                                              "Date",
                                              "Organic"))



```
###SPM
```{r}

Physico_para.df = read.csv("/YOUR/PATH/HERE/Data/PhysicochemicalParameters_mod.txt", encoding = "UTF-8", sep = "\t")
Particle_physico_para.df = unique(Physico_para.df[,c(4:8,10,11,15)])
Particle_physico_para.df = na.omit(Particle_physico_para.df)

Particle_physico_para.df = subset(Particle_physico_para.df, !Sample_date=="Nov-21" & !Station=="BunthausSpitze" )


Particle_physico_para.df$Station = factor(Particle_physico_para.df$Station,
                             levels = c("Meedem Grund", 
                                        "Brunsbuttel",
                                        "Schwarztonnensand",
                                        "Twielenfleth",
                                        "Muhlenberger Loch"
                                        ))
Particle_physico_para.df$Fraction = Particle_physico_para.df$Sample_type
Particle_physico_para.df$Sample_type = NULL
Particle_physico_para.df$Fraction = gsub("Light_fraction", "Suspended", Particle_physico_para.df$Fraction)
Particle_physico_para.df$Fraction = gsub("Heavy_fraction", "Sinking", Particle_physico_para.df$Fraction)
Particle_physico_para.df$Fraction = gsub("Free_living", "Total", Particle_physico_para.df$Fraction)
Particle_physico_para.df$Fraction = factor(Particle_physico_para.df$Fraction,
                                              levels = c("Total",
                                                         "Suspended",
                                                         "Sinking"))
Particle_physico_para.df = subset(Particle_physico_para.df, Fraction!="Total")

Particle_physico_para.df$Date = Particle_physico_para.df$Sample_date
Particle_physico_para.df$Sample_date = NULL
Particle_physico_para.df$Date = gsub("2021.05", "May 21", Particle_physico_para.df$Date)
Particle_physico_para.df$Date = gsub("2021.07", "Jul 21", Particle_physico_para.df$Date)
Particle_physico_para.df$Date = gsub("2022.02", "Feb 22", Particle_physico_para.df$Date)
Particle_physico_para.df$Date = gsub("2022.05", "May 22", Particle_physico_para.df$Date)
Particle_physico_para.df$Date = gsub("2022.06", "Jun 22", Particle_physico_para.df$Date)
Particle_physico_para.df$Date = gsub("2022.11", "Nov 22", Particle_physico_para.df$Date)

Particle_physico_para.df$Date = factor(Particle_physico_para.df$Date,
                                levels = c("May 21",
                                           "Jul 21",
                                           "Feb 22",
                                           "May 22",
                                           "Jun 22",
                                           "Nov 22"))


```
###Merged df
```{r}
dim(Particle_physico_para.df)
dim(CHN.Elbe.sum)

C_SPM.df = merge(Particle_physico_para.df, CHN.Elbe.sum)

C_SPM.df$CtoSPMratio = C_SPM.df$C_mgperL / C_SPM.df$SPM_mgperL


C_SPM_ratio.plt = ggplot(C_SPM.df, 
                            aes(x = Station,
                                y = as.numeric(CtoSPMratio),
                                colour = Fraction,
                                group = Fraction
                                )) + 
  geom_point(size = 2)+
  geom_line(size = 1)+
  facet_grid(Date ~ Organic )+
  theme_bw()+
  ylab("C to SPM ratio")+
  scale_color_manual("Fraction", values = c("Suspended" = "grey50",
                                            "Sinking" = "black"))+
  My_Theme +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

C_SPM_ratio.plt

pdf("/YOUR/PATH/HERE/SupplementaryFigure4_C2SPM.pdf", width = 12, height = 12)
last_plot()
dev.off()




#Get distance from Hamburg/Elbe distance for spearman tests
C_SPM.df$Stromkilometer = C_SPM.df$Station
C_SPM.df$Stromkilometer = gsub("Muhlenberger Loch", 633, C_SPM.df$Stromkilometer)
C_SPM.df$Stromkilometer = gsub("Twielenfleth", 651, C_SPM.df$Stromkilometer)
C_SPM.df$Stromkilometer = gsub("Schwarztonnensand", 665, C_SPM.df$Stromkilometer)
C_SPM.df$Stromkilometer = gsub("Brunsbuttel", 694, C_SPM.df$Stromkilometer)
C_SPM.df$Stromkilometer = gsub("Meedem Grund", 712, C_SPM.df$Stromkilometer)
C_SPM.df = subset(C_SPM.df, Station!="NEGATIVE" & Station!="BunthausSpitze")
C_SPM.df$Stromkilometer = as.numeric(as.character(C_SPM.df$Stromkilometer))

C_SPM.df = subset(C_SPM.df, Date!="May 21" & Date!="Jul 21")

C_SPM_ratio.plt = ggplot(C_SPM.df, 
                            aes(x = Stromkilometer,
                                y = as.numeric(CtoSPMratio),
                                colour = Fraction,
                                group = Fraction
                                )) + 
  geom_point(size = 2)+
  geom_line(size = 1)+
  facet_grid(Date ~ Organic )+
  theme_bw()+
  ylab("C to SPM ratio")+
  scale_color_manual("Fraction", values = c("Suspended" = "grey",
                                            "Sinking" = "black"))+
  scale_x_reverse()+
  My_Theme

C_SPM_ratio.plt + stat_cor()

pdf("/YOUR/PATH/HERE/SupplementaryFigure4_C2SPM.pdf", width = 8, height = 8)
last_plot()
dev.off()


#Calculate mean across dates - fractions were almost identical, so groups were not separated.
MeanDate = C_SPM.df %>%
  group_by(Organic, Date) %>%
  dplyr::summarise(mean_val = mean(CtoSPMratio), sd = sd(CtoSPMratio), median = median(CtoSPMratio))
print(MeanDate)




```

##Supplementary Figure X - Chl a
```{r}


####Prepare df####
Chla.df = read.csv("C:/Users/hunefeldt/OneDrive/Desktop/PhD/R_analysis/ParticleAnalysis/Data/Chl.csv", encoding = "UTF-8", sep = ";")

Chla.df = subset(Chla.df, Date=="28.02.2022" | Date=="22.05.2022" | Date=="20.06.2022" | Date=="08.11.2022")

Chla.df$Date = gsub("28.02.2022", "Feb", Chla.df$Date)
Chla.df$Date = gsub("22.05.2022", "May", Chla.df$Date)
Chla.df$Date = gsub("20.06.2022", "Jun", Chla.df$Date)
Chla.df$Date = gsub("08.11.2022", "Nov", Chla.df$Date)
Chla.df$Date = factor(Chla.df$Date,
                             levels = c("Feb",
                                        "May",
                                        "Jun",
                                        "Nov"))





Chla.plt = ggplot(Chla.df, 
                   aes_string(x = "Elbekilometer",
                       y = "Chla",
                       colour = "Date",
                       group = "Date"
                 )) +
    geom_line(size = 2)+
    geom_point()+
    ylab(expression(Chlorophyll-alpha~"(Âµg"~L^"-1"*")"))+
    xlab("Elbe km")+
    scale_x_reverse()+
    scale_color_manual("Sample Date", values = cbbPalette)+
    My_Theme

Chla.plt

tiff("/YOUR/PATH/HERE/SupplementaryFigure5_Chla.tiff", units = "in", width = 6, height = 4, res = 150)
Chla.plt
dev.off()

png("/YOUR/PATH/HERE/SupplementaryFigure5_Chla.png", units = "in", width = 6, height = 4, res = 150)
Chla.plt
dev.off()


```
##Supplementary Figure 6 Posphate

```{r}

####Prepare df####
Physico_para.df = read.csv("/YOUR/PATH/HERE/Data/PhysicochemicalParameters_mod.txt", encoding = "UTF-8", sep = "\t", header = T)

#Select relevant columns
Water_physico_para.df = unique(Physico_para.df[,c(4:6,8,24,25)])

#Remove unnecessary samples
Water_physico_para.df = Water_physico_para.df[!Water_physico_para.df$StationNumber == 0, ]
Water_physico_para.df = Water_physico_para.df[!Water_physico_para.df$StationNumber == 1, ]
Water_physico_para.df = Water_physico_para.df[!Water_physico_para.df$StationNumber == 1.5, ]
Water_physico_para.df = Water_physico_para.df[!Water_physico_para.df$StationNumber == 4.1, ]
Water_physico_para.df = subset(Water_physico_para.df, Stromkilometer > 610 & Sample_date!="May 21")

#Order Sample sites
Water_physico_para.df$Station = factor(Water_physico_para.df$Station,
                             levels = c("Meedem Grund", 
                                        "Brunsbuttel",
                                        "Schwarztonnensand",
                                        "Twielenfleth",
                                        "Muhlenberger Loch"))
#Order sample dates
Water_physico_para.df$Sample_date = factor(Water_physico_para.df$Sample_date,
                             levels = c("May 21", 
                                        "Jul 21",
                                        "Feb 22",
                                        "May 22",
                                        "Jun 22",
                                        "Nov 22"))

colnames(Water_physico_para.df)

#Remove inorganic phosphate (SRP) from Total dissolved phosphate
Water_physico_para.df$DOP = Water_physico_para.df$TotalDissolvedPhosphate_mg.L - Water_physico_para.df$SRP_mgperL


Water_physico_para.df = subset(Water_physico_para.df, Sample_date!="May 21" & Sample_date!="Jul 21")

DOP_sum.df = Rmisc::summarySE(Water_physico_para.df, 
                             measurevar="DOP", 
                             groupvars=c("Sample_date",
                                         "Stromkilometer"),
                             na.rm = T)

DOP.plt = ggplot(DOP_sum.df, 
                   aes_string(x = "Stromkilometer",
                       y = "DOP",
                       colour = "Sample_date",
                       group = "Sample_date"
                 )) +
    geom_line(size = 2)+
    geom_point(size = 2)+
    ylab("Dissolved Organic \nPhosphate (mg/L)")+
    xlab("Elbe km")+
    scale_x_reverse()+
  scale_y_log10()+
  #ylim(-0.04,0.025)+
    scale_color_manual("Sample Date", values = cbbPalette)+
    My_Theme +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

DOP.plt

SRP_mgperL_sum.df = Rmisc::summarySE(Water_physico_para.df, 
                             measurevar="SRP_mgperL", 
                             groupvars=c("Sample_date",
                                         "Stromkilometer"),
                             na.rm = T)

SRP_mgperL.plt = ggplot(SRP_mgperL_sum.df, 
                   aes_string(x = "Stromkilometer",
                       y = "SRP_mgperL",
                       colour = "Sample_date",
                       group = "Sample_date"
                 )) +
    geom_line(size = 2)+
    geom_point(size = 2)+
    ylab("Soluble Reactive Phosphate \n(mg/L)")+
    xlab("Elbe km")+
    scale_x_reverse()+
  scale_y_log10()+
  #ylim(-0.04,0.025)+
    scale_color_manual("Sample Date", values = cbbPalette)+
    My_Theme +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

SRP_mgperL.plt

ggarrange(DOP.plt, SRP_mgperL.plt, common.legend = T, legend = "right")

pdf("/YOUR/PATH/HERE/SupplementaryFigure6_Phosphate.pdf", width = 12, height = 4)
last_plot()
dev.off()



```


##Supplementary Figure 7 - PAH contamination in Elbe 

```{r}

Cuxhaven_PAH.df = read.csv("/YOUR/PATH/HERE/Data/dbe_gast_20230926_083305708.csv", sep = ";")
Grauerort_PAH.df = read.csv("/YOUR/PATH/HERE/Data/dbe_gast_20230926_083658214.csv", sep = ";")
Seemanshoft_PAH.df = read.csv("/YOUR/PATH/HERE/Data/dbe_gast_20230926_082911439.csv", sep = ";")

FGG_Elbe_PAH.df = rbind(Cuxhaven_PAH.df, Grauerort_PAH.df, Seemanshoft_PAH.df)

unique(FGG_Elbe_PAH.df$X.Einheit.)

FGG_Elbe_PAH.df$X.Datum. = gsub('\\.', '-', FGG_Elbe_PAH.df$X.Datum.)
FGG_Elbe_PAH.df$Date = as.Date(FGG_Elbe_PAH.df$X.Datum., format = "%d-%m-%Y")

str(FGG_Elbe_PAH.df)



ElbePAH.df = FGG_Elbe_PAH.df %>% 
    separate(Date, c("Year","Month", "Day"), sep = "-") 

ElbePAH.df$X.Messwert.
ElbePAH.df$X.Messwert. = gsub(',', '.', ElbePAH.df$X.Messwert.)
ElbePAH.df$X.Messwert.
ElbePAH.df$X.Messwert.[] <- as.numeric(ElbePAH.df$X.Messwert.)
ElbePAH.df$X.Messwert.[is.na(ElbePAH.df$X.Messwert.)] <- 0
ElbePAH.df$X.Messwert.

str(ElbePAH.df)

ElbePAH.df$X.Messwert. = as.numeric(ElbePAH.df$X.Messwert.)
 
ElbePAH_sum.df = Rmisc::summarySE(ElbePAH.df, 
                             measurevar="X.Messwert.", 
                             groupvars=c("Month",
                                         "Year",
                                         "X.Parameter.",
                                         "X.Messstelle."),
                             na.rm = T)

ElbePAH_sum.df$X.Parameter.

ElbePAH_sum.df$X.Parameter. = gsub("'", "", ElbePAH_sum.df$X.Parameter.)
ElbePAH_sum.df$X.Messstelle. = gsub("'", "", ElbePAH_sum.df$X.Messstelle.)
ElbePAH_sum.df$X.Messwert. = gsub("'", "", ElbePAH_sum.df$X.Messwert.)
ElbePAH_sum.df$X.Messstelle. = gsub("Strom-", "Elbe ", ElbePAH_sum.df$X.Messstelle.)
ElbePAH_sum.df$X.Messwert. = as.numeric(ElbePAH_sum.df$X.Messwert.)

ggplot(ElbePAH_sum.df, aes(x=Month, y = X.Messwert., colour = X.Parameter., group = X.Parameter.))+
  geom_line()+
  geom_point()+
  facet_grid(Year ~ X.Messstelle.)+
  My_Theme+
  labs(colour = "Chemical Parameter")+
  xlab("Month of the Year")+
  ylab(expression(Parameter~concentration~"(Âµg"~L^"-1"*")"))+ 
  guides(colour = guide_legend(ncol = 1)) +
  scale_y_log10()


pdf("/YOUR/PATH/HERE/SupplementaryFigure7_PAH.pdf", width = 20, height = 20)
last_plot()
dev.off()
```



